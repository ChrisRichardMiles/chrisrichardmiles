<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Make tidy features from wide time series data.">

<title>../../chrisrichardmiles - Feature engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="../../chrisrichardmiles - Feature engineering">
<meta property="og:description" content="Make tidy features from wide time series data.">
<meta property="og:site-name" content="../../chrisrichardmiles">
<meta name="twitter:title" content="../../chrisrichardmiles - Feature engineering">
<meta name="twitter:description" content="Make tidy features from wide time series data.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">chrisrichardmiles</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Feature engineering</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">chrisrichardmiles</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../core.html" class="sidebar-item-text sidebar-link">Core</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">projects</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">m5</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/index_m5.html" class="sidebar-item-text sidebar-link">Welcome to chrisrichardmiles.m5</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/brief_eda.html" class="sidebar-item-text sidebar-link">Brief EDA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/feature_engineering.html" class="sidebar-item-text sidebar-link active">Feature engineering</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/04_out_of_stock_detection.html" class="sidebar-item-text sidebar-link">Total sales for all series of aggregation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/training_day_by_day_models.html" class="sidebar-item-text sidebar-link">Train day-by-day models</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">optiver</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/index_optiver.html" class="sidebar-item-text sidebar-link">Optiver Realized Volatility Prediction: 91st place solution</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/opt-error-analysis.html" class="sidebar-item-text sidebar-link">Error analysis</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">notebooks</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-book-trade-eda.html" class="sidebar-item-text sidebar-link">price features</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-eda-modified-from-host-nb.html" class="sidebar-item-text sidebar-link">Optiver Realized Volatility Prediction</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart-op-129a-stock-31-only.html" class="sidebar-item-text sidebar-link">opt-train-dart-op-129a-stock-31-only.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart.html" class="sidebar-item-text sidebar-link">opt-train-dart.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-one-at-a-time.html" class="sidebar-item-text sidebar-link">opt-train-one-at-a-time.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-tabnet-142.html" class="sidebar-item-text sidebar-link">opt-train-tabnet-142.html</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#making-a-grid-to-align-all-features" id="toc-making-a-grid-to-align-all-features" class="nav-link active" data-scroll-target="#making-a-grid-to-align-all-features">Making a grid to align all features</a>
  <ul class="collapse">
  <li><a href="#add-prediction-horizon" id="toc-add-prediction-horizon" class="nav-link" data-scroll-target="#add-prediction-horizon">Add prediction horizon</a></li>
  <li><a href="#make-a-tidy-grid" id="toc-make-a-tidy-grid" class="nav-link" data-scroll-target="#make-a-tidy-grid">Make a tidy grid</a></li>
  <li><a href="#isolate-numpy-array-in-rectangle-representation" id="toc-isolate-numpy-array-in-rectangle-representation" class="nav-link" data-scroll-target="#isolate-numpy-array-in-rectangle-representation">Isolate numpy array in “rectangle” representation</a></li>
  <li><a href="#nan_leading_zeros" id="toc-nan_leading_zeros" class="nav-link" data-scroll-target="#nan_leading_zeros">nan_leading_zeros</a></li>
  <li><a href="#main-function" id="toc-main-function" class="nav-link" data-scroll-target="#main-function">Main function</a></li>
  <li><a href="#make_grid_df" id="toc-make_grid_df" class="nav-link" data-scroll-target="#make_grid_df">make_grid_df</a></li>
  </ul></li>
  <li><a href="#base-features" id="toc-base-features" class="nav-link" data-scroll-target="#base-features">Base features</a>
  <ul class="collapse">
  <li><a href="#base-categorical-variables-given-by-heierarchical-levels" id="toc-base-categorical-variables-given-by-heierarchical-levels" class="nav-link" data-scroll-target="#base-categorical-variables-given-by-heierarchical-levels">Base categorical variables given by heierarchical levels</a></li>
  <li><a href="#add_base" id="toc-add_base" class="nav-link" data-scroll-target="#add_base">add_base</a></li>
  <li><a href="#price-features" id="toc-price-features" class="nav-link" data-scroll-target="#price-features">Price features</a></li>
  <li><a href="#create_price_fe" id="toc-create_price_fe" class="nav-link" data-scroll-target="#create_price_fe">create_price_fe</a></li>
  <li><a href="#add_price_fe" id="toc-add_price_fe" class="nav-link" data-scroll-target="#add_price_fe">add_price_fe</a></li>
  <li><a href="#calander-features" id="toc-calander-features" class="nav-link" data-scroll-target="#calander-features">Calander Features</a></li>
  <li><a href="#add_cal_fe" id="toc-add_cal_fe" class="nav-link" data-scroll-target="#add_cal_fe">add_cal_fe</a></li>
  <li><a href="#snap-features" id="toc-snap-features" class="nav-link" data-scroll-target="#snap-features">Snap features</a></li>
  <li><a href="#add_snap_transform_1" id="toc-add_snap_transform_1" class="nav-link" data-scroll-target="#add_snap_transform_1">add_snap_transform_1</a></li>
  <li><a href="#add_snap_transform_2" id="toc-add_snap_transform_2" class="nav-link" data-scroll-target="#add_snap_transform_2">add_snap_transform_2</a></li>
  <li><a href="#special-event-features" id="toc-special-event-features" class="nav-link" data-scroll-target="#special-event-features">Special event features</a></li>
  <li><a href="#add_event_features" id="toc-add_event_features" class="nav-link" data-scroll-target="#add_event_features">add_event_features</a></li>
  <li><a href="#main-function-1" id="toc-main-function-1" class="nav-link" data-scroll-target="#main-function-1">Main function</a></li>
  <li><a href="#fe_base_features" id="toc-fe_base_features" class="nav-link" data-scroll-target="#fe_base_features">fe_base_features</a></li>
  </ul></li>
  <li><a href="#encoding-features-with-target-statistics" id="toc-encoding-features-with-target-statistics" class="nav-link" data-scroll-target="#encoding-features-with-target-statistics">Encoding features with target statistics</a>
  <ul class="collapse">
  <li><a href="#encode_target" id="toc-encode_target" class="nav-link" data-scroll-target="#encode_target">encode_target</a></li>
  <li><a href="#main-function-2" id="toc-main-function-2" class="nav-link" data-scroll-target="#main-function-2">Main function</a></li>
  <li><a href="#fe_encodings" id="toc-fe_encodings" class="nav-link" data-scroll-target="#fe_encodings">fe_encodings</a></li>
  </ul></li>
  <li><a href="#lags-and-rolling-features" id="toc-lags-and-rolling-features" class="nav-link" data-scroll-target="#lags-and-rolling-features">Lags and rolling features</a>
  <ul class="collapse">
  <li><a href="#basic-lag-features" id="toc-basic-lag-features" class="nav-link" data-scroll-target="#basic-lag-features">Basic lag features</a></li>
  <li><a href="#make_lag_col" id="toc-make_lag_col" class="nav-link" data-scroll-target="#make_lag_col">make_lag_col</a></li>
  <li><a href="#add_lags" id="toc-add_lags" class="nav-link" data-scroll-target="#add_lags">add_lags</a></li>
  <li><a href="#fe_lags" id="toc-fe_lags" class="nav-link" data-scroll-target="#fe_lags">fe_lags</a></li>
  <li><a href="#rolling-features" id="toc-rolling-features" class="nav-link" data-scroll-target="#rolling-features">Rolling features</a></li>
  <li><a href="#rolling_window" id="toc-rolling_window" class="nav-link" data-scroll-target="#rolling_window">rolling_window</a></li>
  <li><a href="#split_array" id="toc-split_array" class="nav-link" data-scroll-target="#split_array">split_array</a></li>
  <li><a href="#make_rolling_col" id="toc-make_rolling_col" class="nav-link" data-scroll-target="#make_rolling_col">make_rolling_col</a></li>
  <li><a href="#mean_decay" id="toc-mean_decay" class="nav-link" data-scroll-target="#mean_decay">mean_decay</a></li>
  <li><a href="#diff_nanmean" id="toc-diff_nanmean" class="nav-link" data-scroll-target="#diff_nanmean">diff_nanmean</a></li>
  <li><a href="#diff_mean" id="toc-diff_mean" class="nav-link" data-scroll-target="#diff_mean">diff_mean</a></li>
  <li><a href="#add_rolling_cols" id="toc-add_rolling_cols" class="nav-link" data-scroll-target="#add_rolling_cols">add_rolling_cols</a></li>
  <li><a href="#fe_rw_stats" id="toc-fe_rw_stats" class="nav-link" data-scroll-target="#fe_rw_stats">fe_rw_stats</a></li>
  </ul></li>
  <li><a href="#average-for-each-day-of-the-week" id="toc-average-for-each-day-of-the-week" class="nav-link" data-scroll-target="#average-for-each-day-of-the-week">Average for each day of the week</a>
  <ul class="collapse">
  <li><a href="#feature-telling-how-long-its-been-since-theres-been-a-sale" id="toc-feature-telling-how-long-its-been-since-theres-been-a-sale" class="nav-link" data-scroll-target="#feature-telling-how-long-its-been-since-theres-been-a-sale">Feature telling how long its been since theres been a sale</a></li>
  <li><a href="#get_days_since_sale" id="toc-get_days_since_sale" class="nav-link" data-scroll-target="#get_days_since_sale">get_days_since_sale</a></li>
  <li><a href="#add_dow_means" id="toc-add_dow_means" class="nav-link" data-scroll-target="#add_dow_means">add_dow_means</a></li>
  <li><a href="#main-function-5" id="toc-main-function-5" class="nav-link" data-scroll-target="#main-function-5">Main function</a></li>
  <li><a href="#fe_dow_means" id="toc-fe_dow_means" class="nav-link" data-scroll-target="#fe_dow_means">fe_dow_means</a></li>
  </ul></li>
  <li><a href="#shifted-lag-rolling-features" id="toc-shifted-lag-rolling-features" class="nav-link" data-scroll-target="#shifted-lag-rolling-features">Shifted lag rolling features</a>
  <ul class="collapse">
  <li><a href="#add_shift_cols" id="toc-add_shift_cols" class="nav-link" data-scroll-target="#add_shift_cols">add_shift_cols</a></li>
  <li><a href="#main-function-6" id="toc-main-function-6" class="nav-link" data-scroll-target="#main-function-6">Main function</a></li>
  <li><a href="#fe_shifts_momentum" id="toc-fe_shifts_momentum" class="nav-link" data-scroll-target="#fe_shifts_momentum">fe_shifts_momentum</a></li>
  </ul></li>
  <li><a href="#dimensionality-reduction-of-lags" id="toc-dimensionality-reduction-of-lags" class="nav-link" data-scroll-target="#dimensionality-reduction-of-lags">Dimensionality reduction of lags</a>
  <ul class="collapse">
  <li><a href="#main-function-7" id="toc-main-function-7" class="nav-link" data-scroll-target="#main-function-7">Main function</a></li>
  <li><a href="#fe_ipca_lags" id="toc-fe_ipca_lags" class="nav-link" data-scroll-target="#fe_ipca_lags">fe_ipca_lags</a></li>
  </ul></li>
  <li><a href="#lets-see-all-the-features-we-created" id="toc-lets-see-all-the-features-we-created" class="nav-link" data-scroll-target="#lets-see-all-the-features-we-created">Lets see all the features we created</a></li>
  <li><a href="#make-all-features" id="toc-make-all-features" class="nav-link" data-scroll-target="#make-all-features">Make all features</a>
  <ul class="collapse">
  <li><a href="#fe" id="toc-fe" class="nav-link" data-scroll-target="#fe">fe</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Feature engineering</h1>
</div>

<div>
  <div class="description">
    Make tidy features from wide time series data.
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>,<span class="dv">6</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="dv">16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PATH_DATA <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>PATH_DATA_RAW <span class="op">=</span> <span class="st">'data/raw'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>PATH_DATA_FEATURES <span class="op">=</span> <span class="st">'data/features'</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>os.listdir(PATH_DATA_RAW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">################## Load data ####################</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> pd.read_csv(os.path.join(PATH_DATA_RAW, <span class="st">'sales_train_evaluation.csv'</span>), chunksize<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df_stv <span class="op">=</span> pd.concat(<span class="bu">list</span>(chunks)) <span class="co"># Safe for low RAM situation</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df_cal <span class="op">=</span> pd.read_csv(os.path.join(PATH_DATA_RAW, <span class="st">'calendar.csv'</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>df_prices <span class="op">=</span> pd.read_csv(os.path.join(PATH_DATA_RAW, <span class="st">'sell_prices.csv'</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df_ss <span class="op">=</span> pd.read_csv(os.path.join(PATH_DATA_RAW, <span class="st">'sample_submission.csv'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>What you can get out of this notebook</strong></p>
<ol type="1">
<li>Know how to make lag features from the horizontal “rectangle” data representation, which is how the data starts.</li>
<li>Knoweldge of how to utilize numpy to do quick rolling window aggregations.</li>
</ol>
<section id="making-a-grid-to-align-all-features" class="level2">
<h2 class="anchored" data-anchor-id="making-a-grid-to-align-all-features">Making a grid to align all features</h2>
<p>This section develops code for <code>make_grid_df</code> which will yield: * A dataframe to align all features * A numpy array where each row is a time series. This data representation can be good for for fast feature engineering.</p>
<section id="add-prediction-horizon" class="level3">
<h3 class="anchored" data-anchor-id="add-prediction-horizon">Add prediction horizon</h3>
<p>We will start by adding the prediction horizon to our original data so that feature our features will be generated all training data and our test data at the same time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>last_day <span class="op">=</span> <span class="bu">int</span>(df_stv.columns[<span class="op">-</span><span class="dv">1</span>][<span class="dv">2</span>:])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>pred_horizon <span class="op">=</span> <span class="dv">28</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(last_day <span class="op">+</span> <span class="dv">1</span>, last_day <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> pred_horizon): </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    df_stv[<span class="ss">f'd_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-a-tidy-grid" class="level3">
<h3 class="anchored" data-anchor-id="make-a-tidy-grid">Make a tidy grid</h3>
<p>We want our data in a tidy format, where we have a row for every product/sales_day combination. To do this, we start be reshaping our data to long format. I will call this our <code>grid_df</code>, on which we will build our features</p>
<section id="using-pandas" class="level4">
<h4 class="anchored" data-anchor-id="using-pandas">Using pandas</h4>
<p>We can use pandas dataframe <code>.melt</code> method</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> time.time()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>DROP_COLS <span class="op">=</span> [<span class="st">'item_id'</span>, <span class="st">'dept_id'</span>, <span class="st">'cat_id'</span>, <span class="st">'store_id'</span>, <span class="st">'state_id'</span>]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> df_stv.drop(DROP_COLS, axis<span class="op">=</span><span class="dv">1</span>).melt(id_vars<span class="op">=</span><span class="st">'id'</span>, var_name<span class="op">=</span><span class="st">'d'</span>, value_name<span class="op">=</span><span class="st">'sales'</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Total time for melt: {(time.time() - start_time)/60} min")</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total time for melt: "</span>, time_taken(start_time))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving space</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>grid_df[<span class="st">'d'</span>] <span class="op">=</span> grid_df.d.<span class="bu">str</span>[<span class="dv">2</span>:].astype(np.int16)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total time for day col change: "</span>, time_taken(start_time))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>grid_df[<span class="st">'id'</span>] <span class="op">=</span> grid_df.<span class="bu">id</span>.astype(<span class="st">'category'</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total time for category: "</span>, time_taken(start_time))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time_taken(s))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>display(grid_df)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="faster-grid-ceation-using-numpy" class="level4">
<h4 class="anchored" data-anchor-id="faster-grid-ceation-using-numpy">Faster grid ceation using numpy</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>d_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df_stv.columns <span class="cf">if</span> col.startswith(<span class="st">'d_'</span>)]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> pd.DataFrame({<span class="st">'id'</span>: pd.Series(np.tile(df_stv.<span class="bu">id</span>, <span class="bu">len</span>(d_cols))).astype(<span class="st">'category'</span>), </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'d'</span>: np.concatenate([[<span class="bu">int</span>(s[<span class="dv">2</span>:])] <span class="op">*</span> df_stv.shape[<span class="dv">0</span>] <span class="cf">for</span> s <span class="kw">in</span> d_cols]).astype(np.int16), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'sales'</span>: df_stv[d_cols].values.T.reshape(<span class="op">-</span><span class="dv">1</span>,)})</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Both grids are the same: </span><span class="sc">{</span>grid_df<span class="sc">.</span>equals(g)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="isolate-numpy-array-in-rectangle-representation" class="level3">
<h3 class="anchored" data-anchor-id="isolate-numpy-array-in-rectangle-representation">Isolate numpy array in “rectangle” representation</h3>
<p>I will take the sales values as they are to form my base “rectangle” of sales. I think I can take this recatangle and quickly reshape it so that it lines up with grid_df. If I am correct we can use this to create features quickly.</p>
<p><strong>Test</strong>: Reshape the basic rectangle so that it matches sales of <code>grid_df</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>rec <span class="op">=</span> df_stv[d_cols].values</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>test_sales <span class="op">=</span> rec.T.reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'test_sales matches sales?? '</span>, (np.nan_to_num(test_sales) <span class="op">==</span> grid_df[<span class="st">'sales'</span>].fillna(<span class="dv">0</span>)).<span class="bu">all</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The competition guide states that leading zeros sales should not be considered, therefore we need to convert these leading zeros to NaNs.</p>
<hr>
</section>
<section id="nan_leading_zeros" class="level3">
<h3 class="anchored" data-anchor-id="nan_leading_zeros">nan_leading_zeros</h3>
<blockquote class="blockquote">
<pre><code> nan_leading_zeros (rec)</code></pre>
</blockquote>
<p>Leading zeros indicate an item was not for sale. We will mark as np.nan to ensure they are not used for training.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rec[: <span class="dv">10</span>, :<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nan_leading_zeros(rec[: <span class="dv">10</span>, :<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-function" class="level3">
<h3 class="anchored" data-anchor-id="main-function">Main function</h3>
<hr>
</section>
<section id="make_grid_df" class="level3">
<h3 class="anchored" data-anchor-id="make_grid_df">make_grid_df</h3>
<blockquote class="blockquote">
<pre><code> make_grid_df (df:pandas.core.frame.DataFrame, pred_horizon=28)</code></pre>
</blockquote>
<p>Specific to the the M5 competition data. Returns a grid_df to allign all features and the sales<br>
data in a “rectangle” data representation, a 2D numpy array where ever row is an items time series.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>grid_df, rec <span class="op">=</span> make_grid_df(os.path.join(PATH_DATA_RAW, <span class="st">'sales_train_evaluation.csv'</span>), pred_horizon<span class="op">=</span><span class="dv">28</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>grid_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="base-features" class="level2">
<h2 class="anchored" data-anchor-id="base-features">Base features</h2>
<blockquote class="blockquote">
<p>Functions to create basic calendar and price features</p>
</blockquote>
<p>We start with a grid_df so that all our features will be aligned on the same index making it easy to add features for trianing. grid_df was created in the last few cells.</p>
<section id="base-categorical-variables-given-by-heierarchical-levels" class="level3">
<h3 class="anchored" data-anchor-id="base-categorical-variables-given-by-heierarchical-levels">Base categorical variables given by heierarchical levels</h3>
<p>First, we will add the grouping levels of the data as features. This is easy because the features are already included in df_stv columns. We just need to make a copy of these columns for every day of training and prediction.</p>
<hr>
</section>
<section id="add_base" class="level3">
<h3 class="anchored" data-anchor-id="add_base">add_base</h3>
<blockquote class="blockquote">
<pre><code> add_base (grid_df, df_stv, rec)</code></pre>
</blockquote>
<p>Adds the basic categorical features to grid_df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>add_base(grid_df, df_stv, rec)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>grid_df.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="price-features" class="level3">
<h3 class="anchored" data-anchor-id="price-features">Price features</h3>
<hr>
</section>
<section id="create_price_fe" class="level3">
<h3 class="anchored" data-anchor-id="create_price_fe">create_price_fe</h3>
<blockquote class="blockquote">
<pre><code> create_price_fe (df_prices)</code></pre>
</blockquote>
<p>Adds price features onto price_df. This is the step we take before merging prices onto our grid_df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_prices <span class="op">=</span> create_price_fe(df_prices)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_prices.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="add_price_fe" class="level3">
<h3 class="anchored" data-anchor-id="add_price_fe">add_price_fe</h3>
<blockquote class="blockquote">
<pre><code> add_price_fe (grid_df, df_prices, df_cal)</code></pre>
</blockquote>
<p>Adds on price features to grid_df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> add_price_fe(grid_df, df_prices, df_cal)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calander-features" class="level3">
<h3 class="anchored" data-anchor-id="calander-features">Calander Features</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> grid_df[[<span class="st">'id'</span>, <span class="st">'d'</span>, <span class="st">'sales'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="add_cal_fe" class="level3">
<h3 class="anchored" data-anchor-id="add_cal_fe">add_cal_fe</h3>
<blockquote class="blockquote">
<pre><code> add_cal_fe (grid_df, df_cal)</code></pre>
</blockquote>
<p>Adds calendar features onto grid_df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> add_cal_fe(grid_df, df_cal)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="snap-features" class="level3">
<h3 class="anchored" data-anchor-id="snap-features">Snap features</h3>
<p>The columns with a name like ‘snap_CA’ indicates whether SNAP (also known as EBT) benefits are accepted in California for each day. What days can people use their SNAP benefits</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df_cal.iloc[<span class="op">-</span><span class="dv">180</span>:, :].copy()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df.date)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">'date'</span>).snap_CA.plot(ax<span class="op">=</span>ax[<span class="dv">0</span>], title<span class="op">=</span><span class="st">'California'</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">'date'</span>).snap_TX.plot(ax<span class="op">=</span>ax[<span class="dv">1</span>], title<span class="op">=</span><span class="st">'Texas'</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>df.set_index(<span class="st">'date'</span>).snap_WI.plot(ax<span class="op">=</span>ax[<span class="dv">2</span>], title<span class="op">=</span><span class="st">'Wisconsin'</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].xaxis.set_major_locator(mdates.MonthLocator(bymonthday<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%b %Y"</span>))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Days where people can use SNAP benefits'</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>fig.autofmt_xdate()</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>df_cal[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df_cal[<span class="st">'date'</span>])</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>df_cal.groupby(df_cal.date.dt.day)[[<span class="st">'snap_CA'</span>, <span class="st">'snap_TX'</span>, <span class="st">'snap_WI'</span>]].<span class="bu">sum</span>().plot(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Are the snap days distributed accross these days for the entire dataset?'</span>,kind<span class="op">=</span><span class="st">'bar'</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It seems the snap days are consistent for every month in the dataset since each day has the same number of snap occurances for each date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">############### Snap days of month ###########################</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ca <span class="op">=</span> grid_df[grid_df[<span class="st">'snap_CA'</span>] <span class="op">==</span> <span class="dv">1</span>].tm_d.unique()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>tx <span class="op">=</span> grid_df[grid_df[<span class="st">'snap_TX'</span>] <span class="op">==</span> <span class="dv">1</span>].tm_d.unique()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>wi <span class="op">=</span> grid_df[grid_df[<span class="st">'snap_WI'</span>] <span class="op">==</span> <span class="dv">1</span>].tm_d.unique()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'For each state, what days of the month are snap days?'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'CA:'</span>, ca)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'TX:'</span>, tx)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'WI:'</span>, wi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="simple-feature" class="level4">
<h4 class="anchored" data-anchor-id="simple-feature">Simple feature</h4>
<p>Just map each snap day to 1 through 10 so the model will know which of the 10 snap days it is.</p>
<hr>
</section>
</section>
<section id="add_snap_transform_1" class="level3">
<h3 class="anchored" data-anchor-id="add_snap_transform_1">add_snap_transform_1</h3>
<blockquote class="blockquote">
<pre><code> add_snap_transform_1 (grid_df)</code></pre>
</blockquote>
<p>Adds a column that shows which of the 10 snap days it is. The value is 0 if it is not a snap day.</p>
<section id="a-more-meaningful-mapping" class="level4">
<h4 class="anchored" data-anchor-id="a-more-meaningful-mapping">A more meaningful mapping?</h4>
<p>I would like to transform the snap information in a way that might give more information about non snap days. In particular, I want the “gap” days, non-snap days right in between two snap days, to be considered different from the long stretch of non-snap days towards the end of the month. I’d also like the non-snap days leading into the first snap day to be the same, no matter what state we are considering, so that algorithms can use this feature without needing state information to decode meaning.</p>
<hr>
</section>
</section>
<section id="add_snap_transform_2" class="level3">
<h3 class="anchored" data-anchor-id="add_snap_transform_2">add_snap_transform_2</h3>
<blockquote class="blockquote">
<pre><code> add_snap_transform_2 (grid_df)</code></pre>
</blockquote>
<p>This maps snap days and non snap days in way that may be more meaningful than <code>snap_transform_1</code>.</p>
<p>Any day above 40 will be a snap day. Lower days are non snap, and lowest days are “gap” days in between snap days. In this way I’m hoping the model can can use this feature as non-categorical, and be able to efficiently sort when higher demand days may be. Also, 16-21 will always be the days following the last snap day and 27-31 will be the days leading up to the first snap day. My theory is these numbers will encode more meaning with less confusion caused by states having different snap days.</p>
</section>
<section id="special-event-features" class="level3">
<h3 class="anchored" data-anchor-id="special-event-features">Special event features</h3>
<p>How many days have events?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Type 1: </span><span class="sc">{</span>grid_df<span class="sc">.</span>event_type_1<span class="sc">.</span>count()<span class="op">/</span>grid_df<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> percent'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Type 2: </span><span class="sc">{</span>grid_df<span class="sc">.</span>event_type_2<span class="sc">.</span>count()<span class="op">/</span>grid_df<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> percent'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What special events do we have?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Unique types in event_type_1:'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>display(grid_df.event_type_1.unique().tolist())</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Unique types in event_type_2:'</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>display(grid_df.event_type_2.unique().tolist())</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Unique names in event_name_1:'</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>display(grid_df.event_name_1.unique().tolist())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Do we ever have event_type_2 if there is not an even_type_1?</p>
<p>How often do we have 2 events on the same day?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>grid_df[grid_df.event_name_2.notnull()].drop_duplicates(<span class="st">'d'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (grid_df[<span class="st">'event_type_1'</span>] <span class="op">==</span> <span class="st">'Religious'</span>) <span class="op">&amp;</span> (grid_df[<span class="st">'event_type_2'</span>] <span class="op">==</span> <span class="st">'Cultural'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>grid_df[mask].drop_duplicates(<span class="st">'d'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since there are only a few days with 2 events, I will only consider event_type_1 for my new event features. In the cases where I think the event_type_2 will be more relevant, I will move it to event_type_1. I think cultural event types may be more important than religious events. This will basically amount to making Easter cultural and Cinco De Mayo is also accounted for.</p>
<hr>
</section>
<section id="add_event_features" class="level3">
<h3 class="anchored" data-anchor-id="add_event_features">add_event_features</h3>
<blockquote class="blockquote">
<pre><code> add_event_features (grid_df, n_items=30490, n_days_in_data=1969)</code></pre>
</blockquote>
<p>Adds some features related to special events like holidays to grid_df. The columns added are: next_event_type_1 last_event_type_1 days_since_event days_until_event</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> df_cal, df_prices, df_ss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-function-1" class="level3">
<h3 class="anchored" data-anchor-id="main-function-1">Main function</h3>
<hr>
</section>
<section id="fe_base_features" class="level3">
<h3 class="anchored" data-anchor-id="fe_base_features">fe_base_features</h3>
<blockquote class="blockquote">
<pre><code> fe_base_features (path_data_raw:str&lt;pathtorawdatafolder&gt;='data/raw',
                   path_features:str&lt;pathtofeaturefolder&gt;='data/features',
                   path_to_train_file:str&lt;pathtotraindata&gt;=None)</code></pre>
</blockquote>
<p>Creates the basic categorical, price, and calendar features using the functions <code>add_base</code>, <code>create_price_fe</code>, <code>add_price_fe</code>, and <code>add_cal_fe</code>, <code>add_snap_transform_1</code>, <code>add_snap_transform_1</code>, and <code>add_event_features</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fe_base_features(PATH_DATA_RAW, os.path.join(PATH_DATA, <span class="st">'features'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(PATH_DATA, <span class="st">"features"</span>)<span class="sc">}</span><span class="ss">/fe_base.csv'</span>).info())</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(PATH_DATA, <span class="st">"features"</span>)<span class="sc">}</span><span class="ss">/fe_price.csv'</span>).info())</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(PATH_DATA, <span class="st">"features"</span>)<span class="sc">}</span><span class="ss">/fe_cal.csv'</span>).info())</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(PATH_DATA, <span class="st">"features"</span>)<span class="sc">}</span><span class="ss">/fe_snap_event.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="encoding-features-with-target-statistics" class="level2">
<h2 class="anchored" data-anchor-id="encoding-features-with-target-statistics">Encoding features with target statistics</h2>
<hr>
<section id="encode_target" class="level3">
<h3 class="anchored" data-anchor-id="encode_target">encode_target</h3>
<blockquote class="blockquote">
<pre><code> encode_target (df:pandas.core.frame.DataFrame, target:str,
                cols:Union[list,str], func:Union[str,&lt;built-
                infunctioncallable&gt;], verbose=True)</code></pre>
</blockquote>
<p>Uses pandas groupby(col)[target].transform(<code>func</code>) to encode each col in <code>cols</code>. The <code>target</code> col can be any numerical column.</p>
</section>
<section id="main-function-2" class="level3">
<h3 class="anchored" data-anchor-id="main-function-2">Main function</h3>
<p><strong>Poor encoding</strong></p>
<p>Below is the method I used in the competition. I found that the models performed much better during training, and much worse during validation, so I dropped them from training.</p>
<p>I should have done the encoding more carefully, using no future data. I will explore encodings more in the post competition experiments.</p>
<hr>
</section>
<section id="fe_encodings" class="level3">
<h3 class="anchored" data-anchor-id="fe_encodings">fe_encodings</h3>
<blockquote class="blockquote">
<pre><code> fe_encodings (path_features:&lt;pathtofeaturefolder&gt;='data/features',
               path_out_features:str&lt;pathtofeaturefolderforoutput&gt;=None,
               start_test:int&lt;Firstdaytostartnans&gt;=1942)</code></pre>
</blockquote>
<p>Creates target encoding with mean and std for various columns, with sales after <code>start_test</code> set to np.nan.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fe_encodings()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/fe_enc_mean.csv'</span>).info())</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/fe_enc_std.csv'</span>).info())</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/fe_enc_special.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="lags-and-rolling-features" class="level2">
<h2 class="anchored" data-anchor-id="lags-and-rolling-features">Lags and rolling features</h2>
<blockquote class="blockquote">
<p>These are the features created from the raw sales data directly.</p>
</blockquote>
<p><strong>Be carefule with lag features.</strong> We must be mindful that we will not have the same information for all days in forecast horizon. If we want a single model to predict all days, we can only use lagging features from 28 days and older. In order to create one set of features that we can use for all predictions we will do the following: * Create all lagging features as if we are building a model for 1 day into the future. So “lag_1” means sales one day before the first day of the prediction horizon. * When building a model for the nth day of the horizon, we need to shift the lag features n - 1 extra days. Since we have 30490 time series, We do this by shifting the index of the features by (n - 1) * 30490 so that the lag features for all training and testing data will be lagged by an extra (n - 1) days to keep information aligned properly.</p>
<section id="basic-lag-features" class="level3">
<h3 class="anchored" data-anchor-id="basic-lag-features">Basic lag features</h3>
<p>Before reshaping the data to become a column, we need to shift our rectangle <code>lag_shift</code> by prepended the data with np.nans to make up for the data we have cut off. Therefore, all the d_1 products in grid_df will have np.nan for lag_1. In fact, as we carry out this process for all lag days, rows with sales on d_x will have np.nan values for all lags lag_y where y &gt;= x.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>grid_df, rec <span class="op">=</span> make_grid_df(os.path.join(PATH_DATA_RAW, <span class="st">'sales_train_evaluation.csv'</span>))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>grid_df.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="make_lag_col" class="level3">
<h3 class="anchored" data-anchor-id="make_lag_col">make_lag_col</h3>
<blockquote class="blockquote">
<pre><code> make_lag_col (rec:&lt;built-infunctionarray&gt;, lag:int)</code></pre>
</blockquote>
<p>Transform the ‘rectangle’ of time series into a lag feature</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>rec[:<span class="dv">2</span>, :<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>make_lag_col(rec[:<span class="dv">2</span>, :<span class="dv">5</span>], <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="add_lags" class="level3">
<h3 class="anchored" data-anchor-id="add_lags">add_lags</h3>
<blockquote class="blockquote">
<pre><code> add_lags (grid_df, rec, lags=range(1, 16))</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>add_lags(grid_df, rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="pandas-shift" class="level4">
<h4 class="anchored" data-anchor-id="pandas-shift">Pandas shift</h4>
<p>We can also just use pandas shift which is easier to implement and not much slower. The only downside is that we must use <code>num_series</code> to shift by the correct increment. Here we will do it for g, which was the same as grid_df before adding lags. Our time was not wasted though, because we learned skills that we will need for making rolling windows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rec.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>g, rec_tmp <span class="op">=</span> make_grid_df(os.path.join(PATH_DATA_RAW, <span class="st">'sales_train_evaluation.csv'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>num_series <span class="op">=</span> df_stv.shape[<span class="dv">0</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">16</span>):</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    g[<span class="ss">f'lag_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> g[<span class="st">'sales'</span>].shift(num_series <span class="op">*</span> i).astype(np.float16)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> g</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>gc.collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-function-3" class="level4">
<h4 class="anchored" data-anchor-id="main-function-3">Main function</h4>
<hr>
</section>
</section>
<section id="fe_lags" class="level3">
<h3 class="anchored" data-anchor-id="fe_lags">fe_lags</h3>
<blockquote class="blockquote">
<pre><code> fe_lags (path_data_raw:str&lt;pathtorawdatafolder&gt;='data/raw',
          path_features:str&lt;pathtofeaturefolder&gt;='data/features',
          path_to_train_file:str&lt;pathtotraindata&gt;=None)</code></pre>
</blockquote>
<p>Creates lags and rolling window features using <code>add_lags</code> <code>add_rolling_cols</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fe_lags()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_lags(PATH_DATA_RAW, path_features='.')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>max_lag <span class="op">=</span> <span class="dv">84</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>cols_per_file <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_lag, cols_per_file):</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_lags_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>lag <span class="op">+</span> cols_per_file <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rolling-features" class="level3">
<h3 class="anchored" data-anchor-id="rolling-features">Rolling features</h3>
<section id="rolling-window-function" class="level4">
<h4 class="anchored" data-anchor-id="rolling-window-function">rolling window function</h4>
<p>Please check out <a href="https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html">“Efficient rolling statistics with NumPy”</a> by <a href="https://rigtorp.se/">Erik Rigtorp</a>. The article shows some cool numpy tricks to do really fast rolling window calculations by creating “rolling windows views”</p>
<p><strong>Update to the article 2021-04-21:</strong> “NumPy now comes with a builtin function sliding_window_view that does exactly this. There’s also the Bottleneck library with optimized functions for rolling mean, standard deviation etc.”</p>
<hr>
</section>
</section>
<section id="rolling_window" class="level3">
<h3 class="anchored" data-anchor-id="rolling_window">rolling_window</h3>
<blockquote class="blockquote">
<pre><code> rolling_window (a:&lt;built-infunctionarray&gt;, window:int)</code></pre>
</blockquote>
<p>A super fast way of getting rolling window view with size <code>window</code> on a numpy array. Reference: https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">10</span>).reshape((<span class="dv">2</span>,<span class="dv">5</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>rw <span class="op">=</span> rolling_window(x, <span class="dv">3</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>rw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>np.mean(rw, axis<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>np.std(rw, axis<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>np.median(rw, axis<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> x, rw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="split_array" class="level3">
<h3 class="anchored" data-anchor-id="split_array">split_array</h3>
<blockquote class="blockquote">
<pre><code> split_array (ary, sections, axis=0)</code></pre>
</blockquote>
<p>Works just like np.split, but sections must be a single integer. It will work, even when sections doesn’t evenly divide the length of ary.</p>
<p>This avoids errors that occur when using <code>make_rolling_col</code> with high <code>n_splits</code> that do not divide the number of series evenly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array(<span class="bu">range</span>(<span class="dv">9</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>split_array(x, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="make_rolling_col" class="level3">
<h3 class="anchored" data-anchor-id="make_rolling_col">make_rolling_col</h3>
<blockquote class="blockquote">
<pre><code> make_rolling_col (rw, function, n_splits=10)</code></pre>
</blockquote>
<p>Returns a one dimensional np.array after <code>function</code> has been applied to the rolling window view <code>rw</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>rw <span class="op">=</span> rolling_window(rec, <span class="dv">3</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'The shape </span><span class="sc">{</span>rw<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, represents (num_series, num_windows, window_size)'</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>function <span class="op">=</span> np.mean</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> make_rolling_col(rw, function)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Make sure the shape of the resulting column matches grid_df'</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(grid_df.shape[<span class="dv">0</span>],<span class="st">'='</span>,  col.shape[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">10</span>).reshape((<span class="dv">2</span>,<span class="dv">5</span>))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>rw <span class="op">=</span> rolling_window(x, <span class="dv">3</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>make_rolling_col(rw, function, n_splits<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> rw, function, col</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="some-more-functions-for-rolling-windows" class="level4">
<h4 class="anchored" data-anchor-id="some-more-functions-for-rolling-windows">Some more functions for rolling windows</h4>
<p>These functions are designed to act on a rolling_window array created by the rolling_window function, similar to np.mean or np.std.</p>
<hr>
</section>
</section>
<section id="mean_decay" class="level3">
<h3 class="anchored" data-anchor-id="mean_decay">mean_decay</h3>
<blockquote class="blockquote">
<pre><code> mean_decay (rolling_window, axis=-1)</code></pre>
</blockquote>
<p>Returns the mean_decay along an axis of a rolling window object, which is created by the rolling_window() function.</p>
<hr>
</section>
<section id="diff_nanmean" class="level3">
<h3 class="anchored" data-anchor-id="diff_nanmean">diff_nanmean</h3>
<blockquote class="blockquote">
<pre><code> diff_nanmean (rolling_window, axis=-1)</code></pre>
</blockquote>
<p>For M5 purposes, used on an object generated by the rolling_window function. Returns the mean of the first difference of a window of sales.</p>
<hr>
</section>
<section id="diff_mean" class="level3">
<h3 class="anchored" data-anchor-id="diff_mean">diff_mean</h3>
<blockquote class="blockquote">
<pre><code> diff_mean (rolling_window, axis=-1)</code></pre>
</blockquote>
<p>For M5 purposes, used on an object generated by the rolling_window function. Returns the mean of the first difference of a window of sales.</p>
<hr>
</section>
<section id="add_rolling_cols" class="level3">
<h3 class="anchored" data-anchor-id="add_rolling_cols">add_rolling_cols</h3>
<blockquote class="blockquote">
<pre><code> add_rolling_cols (grid_df:pandas.core.frame.DataFrame, rec:&lt;built-
                   infunctionarray&gt;, windows:list, functions:list,
                   function_names:list=None, n_splits:list=10)</code></pre>
</blockquote>
<p>Adds rolling features to grid_df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> add_rolling_cols(grid_df, </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                 rec, </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                 windows<span class="op">=</span>[<span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">140</span>], </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                 functions<span class="op">=</span>[np.mean, np.std], </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>                 function_names<span class="op">=</span>[<span class="st">'mean'</span>, <span class="st">'std'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="main-function-4" class="level4">
<h4 class="anchored" data-anchor-id="main-function-4">Main function</h4>
<hr>
</section>
</section>
<section id="fe_rw_stats" class="level3">
<h3 class="anchored" data-anchor-id="fe_rw_stats">fe_rw_stats</h3>
<blockquote class="blockquote">
<pre><code> fe_rw_stats (path_data_raw:str&lt;pathtorawdatafolder&gt;='data/raw',
              path_features:str&lt;pathtofeaturefolder&gt;='data/features',
              path_to_train_file:str&lt;pathtotraindata&gt;=None)</code></pre>
</blockquote>
<p>Creates lags and rolling window features using <code>add_lags</code> <code>add_rolling_cols</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>fe_rw_stats()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_rw_stats(PATH_DATA_RAW, path_features='.')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_rw_1.csv'</span>).info())</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_rw_2.csv'</span>).info())</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_rw_3.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="average-for-each-day-of-the-week" class="level2">
<h2 class="anchored" data-anchor-id="average-for-each-day-of-the-week">Average for each day of the week</h2>
<section id="feature-telling-how-long-its-been-since-theres-been-a-sale" class="level3">
<h3 class="anchored" data-anchor-id="feature-telling-how-long-its-been-since-theres-been-a-sale">Feature telling how long its been since theres been a sale</h3>
<hr>
</section>
<section id="get_days_since_sale" class="level3">
<h3 class="anchored" data-anchor-id="get_days_since_sale">get_days_since_sale</h3>
<blockquote class="blockquote">
<pre><code> get_days_since_sale (grid_df, num_series=30490)</code></pre>
</blockquote>
<p>Returns a column that shows how many days its been Since there has been a sale.</p>
<hr>
</section>
<section id="add_dow_means" class="level3">
<h3 class="anchored" data-anchor-id="add_dow_means">add_dow_means</h3>
<blockquote class="blockquote">
<pre><code> add_dow_means (grid_df, rec, n_weeks)</code></pre>
</blockquote>
<p>Adds features to grid_df for the mean of each day of the week for the past <code>n_weeks</code>.</p>
<p>For any row, the column ‘mean_{n_weeks}<em>dow</em>{i}’ represents the mean of the last <code>n_weeks</code> of sales for the day of the week that is <code>i</code> days behind the date of this row. So if today is Friday, n_weeks=4 and i = 1, this column is equal to the mean sales of the last 4 Thursdays.</p>
</section>
<section id="main-function-5" class="level3">
<h3 class="anchored" data-anchor-id="main-function-5">Main function</h3>
<hr>
</section>
<section id="fe_dow_means" class="level3">
<h3 class="anchored" data-anchor-id="fe_dow_means">fe_dow_means</h3>
<blockquote class="blockquote">
<pre><code> fe_dow_means (path_data_raw:str&lt;pathtorawdatafolder&gt;='data/raw',
               path_features:str&lt;pathtofeaturefolder&gt;='data/features',
               path_to_train_file:str&lt;pathtotraindata&gt;=None)</code></pre>
</blockquote>
<p>Creates the features for day of week means using <code>add_dow_means</code></p>
<p>We also use ‘get_days_since_sale’ in this script since there isn’t another group very similar to this feature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_dow_means(PATH_DATA_RAW, '.')\</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>fe_dow_means()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_dow_means_and_days_since_sale.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="shifted-lag-rolling-features" class="level2">
<h2 class="anchored" data-anchor-id="shifted-lag-rolling-features">Shifted lag rolling features</h2>
<p>Perhaps I want to also want to know 7 day rolling mean, but from 7 seven days ago. This could go directly into a model, or we could create a weekly <code>momentum_7_rolling_mean_7 = shift_1_rolling_mean_7/shift_8_rolling_mean_7</code>. We have already calculated these features, we just need to shift the columns by <code>num_series * (shift_days - 1)</code>. We subtract 1 from shift_days because the column shift_1_rolling_mean_7 is already shifted 1 day.</p>
<hr>
<section id="add_shift_cols" class="level3">
<h3 class="anchored" data-anchor-id="add_shift_cols">add_shift_cols</h3>
<blockquote class="blockquote">
<pre><code> add_shift_cols (grid_df:pandas.core.frame.DataFrame, shifts:list,
                 cols:list, num_series:int=30490, momentum:bool=True)</code></pre>
</blockquote>
<p>Adds shift_{<code>shift</code>} and momentum_{<code>shift</code> - 1} features for each int <code>shift</code> in <code>shifts</code> for each column in <code>cols</code>. <code>cols</code> must be a list of columns that begin with ‘shift_1’ for this function to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">############## Adding shifted rolling mean ###############</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>shifts <span class="op">=</span> [<span class="dv">8</span>, <span class="dv">15</span>, <span class="dv">22</span>, <span class="dv">29</span>]</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="ss">f'shift_1_rolling_mean_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">7</span>, <span class="dv">14</span>]]</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>add_shift_cols(grid_df, shifts, cols, num_series<span class="op">=</span>df_stv.shape[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>grid_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-function-6" class="level3">
<h3 class="anchored" data-anchor-id="main-function-6">Main function</h3>
<hr>
</section>
<section id="fe_shifts_momentum" class="level3">
<h3 class="anchored" data-anchor-id="fe_shifts_momentum">fe_shifts_momentum</h3>
<blockquote class="blockquote">
<pre><code> fe_shifts_momentum
                     (path_features:str&lt;pathtofeaturefolder&gt;='data/feature
                     s', path_out_features:str&lt;pathtofeaturefolderforoutpu
                     t&gt;='',
                     num_series:int&lt;Numberofseriesforshifting&gt;=30490)</code></pre>
</blockquote>
<p>Creates shifts and momentum features using <code>add_shift_cols</code></p>
<p>Parameters</p>
<hr>
<p>path_features: Param(‘path to feature folder’, str)=‘data/features’</p>
<p>path_out_features: Param(‘path to feature folder for output’, str)=‘data/features’ This is mainly to run on kaggle where <code>path_features</code> is set to an input dataset, because we need the rolling window stat features to be present, and <code>path_out_features</code> is set the working directory for the output.</p>
<p>num_series: Param(‘Number of series for shifting’, int)=30490</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_shifts_momentum('.', num_series=df_stv.shape[0])</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># time.sleep(1)</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>fe_shifts_momentum(num_series<span class="op">=</span>df_stv.shape[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_shifts_mom_1.csv'</span>).info())</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_shifts_mom_2.csv'</span>).info())</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_shifts_mom_3.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="dimensionality-reduction-of-lags" class="level2">
<h2 class="anchored" data-anchor-id="dimensionality-reduction-of-lags">Dimensionality reduction of lags</h2>
<p>Since we have so many lags, I will try to use pca to reduce the number of features I have. I can’t fit all the lags into memory, so I will create the pca features iteratively, starting with lags 71 through 84, save the file, then save the top 7 components to do pca again with lags 57 through 70, and so on until I have 14 pca components for lags 1 through 84. Then I can decide how many lags features I want to keep without reducing their dimension.</p>
<section id="main-function-7" class="level3">
<h3 class="anchored" data-anchor-id="main-function-7">Main function</h3>
<hr>
</section>
<section id="fe_ipca_lags" class="level3">
<h3 class="anchored" data-anchor-id="fe_ipca_lags">fe_ipca_lags</h3>
<blockquote class="blockquote">
<pre><code> fe_ipca_lags (path_data_raw:str&lt;pathtorawdatafolder&gt;='data/raw',
               path_features:str&lt;Pathtofeaturefile&gt;='data/features',
               path_to_train_file:str&lt;pathtotraindata&gt;=None,
               end:int&lt;lastdaytostartlagsfrom&gt;=1, restart:int&lt;startifresum
               ingwithlags_df.pklinrestart_dir&gt;=None,
               target:str&lt;Nameoftargetcolumn&gt;='sales')</code></pre>
</blockquote>
<p>Creates ipca columns for 84 lag days, starting from the end and accumulating backward. With 16 GB of RAM, we can only fit 14 with ipca at a time, so for each iteration, we:</p>
<pre><code>1) Create 14 new lag days, and use ipca to reduce it to 
the top 7 compnents.
2) Combine those with the top 7 components from the previous step
3) Perform ipca on these 14, features, save the output, and 
keep the top 7 components for the next iteration.</code></pre>
<p>In the end we will have files with the top 14 ipca components for each of these separate ranges: Days 1_84 Days 15_84 Days 29_84 Days 43_84 Days 57_84 Days 71_84</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_ipca_lags(PATH_DATA_RAW, '.')</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>fe_ipca_lags()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_1_84.csv'</span>).info())</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_15_84.csv'</span>).info())</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_29_84.csv'</span>).info())</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_43_84.csv'</span>).info())</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_57_84.csv'</span>).info())</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>display(load_file(<span class="ss">f'</span><span class="sc">{</span>PATH_DATA_FEATURES<span class="sc">}</span><span class="ss">/shift_fe_ipca_71_84.csv'</span>).info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="lets-see-all-the-features-we-created" class="level2">
<h2 class="anchored" data-anchor-id="lets-see-all-the-features-we-created">Lets see all the features we created</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>get_file_cols_dict(PATH_DATA_FEATURES)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>rm data<span class="op">/</span>features<span class="op">/*</span>csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-all-features" class="level2">
<h2 class="anchored" data-anchor-id="make-all-features">Make all features</h2>
<hr>
<section id="fe" class="level3">
<h3 class="anchored" data-anchor-id="fe">fe</h3>
<blockquote class="blockquote">
<pre><code> fe ()</code></pre>
</blockquote>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>