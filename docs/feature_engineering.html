---

title: Feature engineering


keywords: fastai
sidebar: home_sidebar

summary: "Make tidy features from wide time series data. "
description: "Make tidy features from wide time series data. "
nb_path: "projects/m5/03_feature_engineering.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: projects/m5/03_feature_engineering.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'font.size'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PATH_DATA</span> <span class="o">=</span> <span class="s1">'data'</span>
<span class="n">PATH_DATA_RAW</span> <span class="o">=</span> <span class="s1">'data/raw'</span>
<span class="n">PATH_DATA_FEATURES</span> <span class="o">=</span> <span class="s1">'data/features'</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">chunks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sales_train_evaluation.csv'</span><span class="p">),</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">df_stv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span> <span class="c1"># Safe for low RAM situation</span>
<span class="n">df_cal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'calendar.csv'</span><span class="p">))</span>
<span class="n">df_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sell_prices.csv'</span><span class="p">))</span>
<span class="n">df_ss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sample_submission.csv'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>What you can get out of this notebook</strong></p>
<ol>
<li>Know how to make lag features from the horizontal "rectangle" data representation, which is how the data starts.</li>
<li>Knoweldge of how to utilize numpy to do quick rolling window aggregations.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Making-a-grid-to-align-all-features">Making a grid to align all features<a class="anchor-link" href="#Making-a-grid-to-align-all-features"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This section develops code for <a href="/chrisrichardmiles/feature_engineering.html#make_grid_df"><code>make_grid_df</code></a> which will yield:</p>
<ul>
<li>A dataframe to align all features</li>
<li>A numpy array where each row is a time series. This data representation can be good for for fast feature engineering.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Add-prediction-horizon">Add prediction horizon<a class="anchor-link" href="#Add-prediction-horizon"> </a></h3><p>We will start by adding the prediction horizon to our original data so that feature our features will be generated all training data and our test data at the same time.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">last_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_stv</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
<span class="n">pred_horizon</span> <span class="o">=</span> <span class="mi">28</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_day</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_day</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pred_horizon</span><span class="p">):</span> 
    <span class="n">df_stv</span><span class="p">[</span><span class="sa">f</span><span class="s1">'d_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Make-a-tidy-grid">Make a tidy grid<a class="anchor-link" href="#Make-a-tidy-grid"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We want our data in a tidy format, where we have a row for every 
product/sales_day combination. To do this, we start be reshaping 
our data to long format. I will call this our <code>grid_df</code>, on which we
will build our features</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Using-pandas">Using pandas<a class="anchor-link" href="#Using-pandas"> </a></h4><p>We can use pandas dataframe <code>.melt</code> method</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">DROP_COLS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'dept_id'</span><span class="p">,</span> <span class="s1">'cat_id'</span><span class="p">,</span> <span class="s1">'store_id'</span><span class="p">,</span> <span class="s1">'state_id'</span><span class="p">]</span>
<span class="n">grid_df</span> <span class="o">=</span> <span class="n">df_stv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">DROP_COLS</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">'id'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">'d'</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">'sales'</span><span class="p">)</span>
<span class="c1"># print(f"Total time for melt: {(time.time() - start_time)/60} min")</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total time for melt: "</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>


<span class="c1"># Saving space</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_df</span><span class="p">[</span><span class="s1">'d'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total time for day col change: "</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_df</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total time for category: "</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">(</span><span class="n">start_time</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">time_taken</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">grid_df</span><span class="p">)</span>

<span class="k">del</span> <span class="n">s</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Faster-grid-ceation-using-numpy">Faster grid ceation using numpy<a class="anchor-link" href="#Faster-grid-ceation-using-numpy"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">d_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_stv</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'d_'</span><span class="p">)]</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'id'</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">df_stv</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_cols</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">),</span> 
                  <span class="s1">'d'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])]</span> <span class="o">*</span> <span class="n">df_stv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">d_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> 
                  <span class="s1">'sales'</span><span class="p">:</span> <span class="n">df_stv</span><span class="p">[</span><span class="n">d_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)})</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Both grids are the same: </span><span class="si">{</span><span class="n">grid_df</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Isolate-numpy-array-in-%22rectangle%22-representation">Isolate numpy array in "rectangle" representation<a class="anchor-link" href="#Isolate-numpy-array-in-%22rectangle%22-representation"> </a></h3><p>I will take the sales values as they are to 
form my base "rectangle" of sales. 
I think I can take this recatangle and 
quickly reshape it so that it lines up 
with grid_df. If I am correct we can use this 
to create features quickly.</p>
<p><strong>Test</strong>:
Reshape the basic 
rectangle so that it matches sales of <code>grid_df</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rec</span> <span class="o">=</span> <span class="n">df_stv</span><span class="p">[</span><span class="n">d_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">test_sales</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'test_sales matches sales?? '</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">test_sales</span><span class="p">)</span> <span class="o">==</span> <span class="n">grid_df</span><span class="p">[</span><span class="s1">'sales'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The competition guide states that leading zeros sales should not be considered, therefore we need to convert these leading zeros to NaNs.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="nan_leading_zeros" class="doc_header"><code>nan_leading_zeros</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nan_leading_zeros</code>(<strong><code>rec</code></strong>)</p>
</blockquote>
<p>Leading zeros indicate an item was not for sale. We
will mark as np.nan to ensure they are not used for training.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">rec</span><span class="p">[:</span> <span class="mi">10</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nan_leading_zeros</span><span class="p">(</span><span class="n">rec</span><span class="p">[:</span> <span class="mi">10</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_grid_df" class="doc_header"><code>make_grid_df</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_grid_df</code>(<strong><code>df</code></strong>:<code>df or path_to_train_file</code>, <strong><code>pred_horizon</code></strong>=<em><code>28</code></em>)</p>
</blockquote>
<p>Specific to the the M5 competition data.
Returns a grid_df to allign all features and the sales
data in a "rectangle" data representation, a 2D numpy array
where ever row is an items time series.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="p">,</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">make_grid_df</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sales_train_evaluation.csv'</span><span class="p">),</span> <span class="n">pred_horizon</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rec</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Base-features">Base features<a class="anchor-link" href="#Base-features"> </a></h2><blockquote><p>Functions to create basic calendar and price features</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We start with a grid_df so that all our 
features will be aligned on the same index 
making it easy to add features for trianing. 
grid_df was created in the last few cells.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Base-categorical-variables-given-by-heierarchical-levels">Base categorical variables given by heierarchical levels<a class="anchor-link" href="#Base-categorical-variables-given-by-heierarchical-levels"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, we will add the grouping levels 
of the data as features. This is easy 
because the features are already included 
in df_stv columns. We just need to make a copy of 
these columns for every day of training and 
prediction.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_base" class="doc_header"><code>add_base</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L79" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_base</code>(<strong><code>grid_df</code></strong>, <strong><code>df_stv</code></strong>, <strong><code>rec</code></strong>)</p>
</blockquote>
<p>Adds the basic categorical features to grid_df.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">add_base</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">df_stv</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
<span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Price-features">Price features<a class="anchor-link" href="#Price-features"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_price_fe" class="doc_header"><code>create_price_fe</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L90" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>create_price_fe</code>(<strong><code>df_prices</code></strong>)</p>
</blockquote>
<p>Adds price features onto price_df. This is the step we take
before merging prices onto our grid_df.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_prices</span> <span class="o">=</span> <span class="n">create_price_fe</span><span class="p">(</span><span class="n">df_prices</span><span class="p">)</span>
<span class="n">df_prices</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_price_fe" class="doc_header"><code>add_price_fe</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_price_fe</code>(<strong><code>grid_df</code></strong>, <strong><code>df_prices</code></strong>, <strong><code>df_cal</code></strong>)</p>
</blockquote>
<p>Adds on price features to grid_df.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span> <span class="o">=</span> <span class="n">add_price_fe</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">df_prices</span><span class="p">,</span> <span class="n">df_cal</span><span class="p">)</span>
<span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Calander-Features">Calander Features<a class="anchor-link" href="#Calander-Features"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[[</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">,</span> <span class="s1">'sales'</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_cal_fe" class="doc_header"><code>add_cal_fe</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L162" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_cal_fe</code>(<strong><code>grid_df</code></strong>, <strong><code>df_cal</code></strong>)</p>
</blockquote>
<p>Adds calendar features onto grid_df.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span> <span class="o">=</span> <span class="n">add_cal_fe</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">df_cal</span><span class="p">)</span>
<span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Snap-features">Snap features<a class="anchor-link" href="#Snap-features"> </a></h3><p>The columns with a name like 'snap_CA' indicates whether SNAP (also known as EBT) benefits are accepted in California for each day. What days can people use their SNAP benefits</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_cal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span><span class="o">.</span><span class="n">snap_CA</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">'California'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span><span class="o">.</span><span class="n">snap_TX</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Texas'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span><span class="o">.</span><span class="n">snap_WI</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Wisconsin'</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">(</span><span class="n">bymonthday</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">"%b %Y"</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">'Days where people can use SNAP benefits'</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">()</span>
<span class="n">df_cal</span><span class="p">[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_cal</span><span class="p">[</span><span class="s1">'date'</span><span class="p">])</span>
<span class="n">df_cal</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_cal</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)[[</span><span class="s1">'snap_CA'</span><span class="p">,</span> <span class="s1">'snap_TX'</span><span class="p">,</span> <span class="s1">'snap_WI'</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">'Are the snap days distributed accross these days for the entire dataset?'</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">'bar'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It seems the snap days are consistent for every month in the dataset since each day has the same number of snap occurances for each date.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ca</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">'snap_CA'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tm_d</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">tx</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">'snap_TX'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tm_d</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">wi</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">'snap_WI'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tm_d</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'For each state, what days of the month are snap days?'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'CA:'</span><span class="p">,</span> <span class="n">ca</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'TX:'</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'WI:'</span><span class="p">,</span> <span class="n">wi</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Simple-feature">Simple feature<a class="anchor-link" href="#Simple-feature"> </a></h4><p>Just map each snap day to 1 through 10 so the 
model will know which of the 10 snap days it is.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_snap_transform_1" class="doc_header"><code>add_snap_transform_1</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L209" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_snap_transform_1</code>(<strong><code>grid_df</code></strong>)</p>
</blockquote>
<p>Adds a column that shows which of the 10 snap days it is.
The value is 0 if it is not a snap day.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="A-more-meaningful-mapping?">A more meaningful mapping?<a class="anchor-link" href="#A-more-meaningful-mapping?"> </a></h4><p>I would like to transform the snap information in a way that might give more information about non snap days. In particular, I want the "gap" days, non-snap days right in between two snap days, to be considered different from the long stretch of non-snap days towards the end of the month. I'd also like the non-snap days leading into the first snap day to be the same, no matter what state we are considering, so that algorithms can use this feature without needing state information to decode meaning.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_snap_transform_2" class="doc_header"><code>add_snap_transform_2</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L241" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_snap_transform_2</code>(<strong><code>grid_df</code></strong>)</p>
</blockquote>
<p>This maps snap days and non snap days in way
that may be more meaningful than <code>snap_transform_1</code>.</p>
<p>Any day above 40 will be a snap day. Lower days are non
snap, and lowest days are "gap" days in between
snap days. In this way I'm hoping the model can
can use this feature as non-categorical, and be
able to efficiently sort when higher demand days
may be. Also, 16-21 will always be the days
following the last snap day and 27-31 will be
the days leading up to the first snap day. My theory is
these numbers will encode more meaning with less
confusion caused by states having different snap days.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Special-event-features">Special event features<a class="anchor-link" href="#Special-event-features"> </a></h3><p>How many days have events?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Type 1: </span><span class="si">{</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_type_1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="n">grid_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> percent'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Type 2: </span><span class="si">{</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_type_2</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="n">grid_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> percent'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What special events do we have?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'Unique types in event_type_1:'</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_type_1</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Unique types in event_type_2:'</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_type_2</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Unique names in event_name_1:'</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_name_1</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Do we ever have event_type_2 if there is not an even_type_1?</p>
<p>How often do we have 2 events on the same day?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="p">[</span><span class="n">grid_df</span><span class="o">.</span><span class="n">event_name_2</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">'d'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">'event_type_1'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Religious'</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s1">'event_type_2'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Cultural'</span><span class="p">)</span>
<span class="n">grid_df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">'d'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since there are only a few days with 2 events, I will only consider event_type_1 for my new event features. In the cases where I think the event_type_2 will be more relevant, I will move it to event_type_1. I think cultural event types may be more important than religious events. This will basically amount to making Easter cultural and Cinco De Mayo is also accounted for.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_event_features" class="doc_header"><code>add_event_features</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L286" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_event_features</code>(<strong><code>grid_df</code></strong>, <strong><code>n_items</code></strong>=<em><code>30490</code></em>, <strong><code>n_days_in_data</code></strong>=<em><code>1969</code></em>)</p>
</blockquote>
<p>Adds some features related to special events like holidays to
grid_df. The columns added are:
next_event_type_1
last_event_type_1
days_since_event
days_until_event</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">df_cal</span><span class="p">,</span> <span class="n">df_prices</span><span class="p">,</span> <span class="n">df_ss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_base_features" class="doc_header"><code>fe_base_features</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L335" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_base_features</code>(<strong><code>path_data_raw</code></strong>:"path to raw data folder"=<em><code>'data/raw'</code></em>, <strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_to_train_file</code></strong>:"path to train data"=<em><code>None</code></em>)</p>
</blockquote>
<p>Creates the basic categorical, price, and calendar features using
the functions <a href="/chrisrichardmiles/feature_engineering.html#add_base"><code>add_base</code></a>, <a href="/chrisrichardmiles/feature_engineering.html#create_price_fe"><code>create_price_fe</code></a>, <a href="/chrisrichardmiles/feature_engineering.html#add_price_fe"><code>add_price_fe</code></a>, and <a href="/chrisrichardmiles/feature_engineering.html#add_cal_fe"><code>add_cal_fe</code></a>,
<a href="/chrisrichardmiles/feature_engineering.html#add_snap_transform_1"><code>add_snap_transform_1</code></a>, <a href="/chrisrichardmiles/feature_engineering.html#add_snap_transform_1"><code>add_snap_transform_1</code></a>, and <a href="/chrisrichardmiles/feature_engineering.html#add_event_features"><code>add_event_features</code></a>.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_data_raw: Param('path to raw data folder', str)='data/raw'
path_features: Param('path to feature folder', str)='data/features'
path_to_train_file: Param('path to train data', str)=None
    This is so we can <code>oos_sales_train_evaluation.csv</code> file which is
    the result of filling zero streaks with NaN where we think an item
    is out of stock.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_base_features</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA</span><span class="p">,</span> <span class="s1">'features'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA</span><span class="p">,</span> <span class="s2">"features"</span><span class="p">)</span><span class="si">}</span><span class="s1">/fe_base.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA</span><span class="p">,</span> <span class="s2">"features"</span><span class="p">)</span><span class="si">}</span><span class="s1">/fe_price.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA</span><span class="p">,</span> <span class="s2">"features"</span><span class="p">)</span><span class="si">}</span><span class="s1">/fe_cal.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA</span><span class="p">,</span> <span class="s2">"features"</span><span class="p">)</span><span class="si">}</span><span class="s1">/fe_snap_event.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Encoding-features-with-target-statistics">Encoding features with target statistics<a class="anchor-link" href="#Encoding-features-with-target-statistics"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="encode_target" class="doc_header"><code>encode_target</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L419" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>encode_target</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>target</code></strong>:<code>str</code>, <strong><code>cols</code></strong>:<code>Union</code>[<code>list</code>, <code>str</code>], <strong><code>func</code></strong>:<code>Union</code>[<code>str</code>, <code>callable</code>], <strong><code>verbose</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Uses pandas groupby(col)[target].transform(<code>func</code>) to encode
each col in <code>cols</code>. The <code>target</code> col can be any numerical column.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>df: pd.DataFrame
    DataFrame to use
target: str
    Name of column to be encoded
cols: Union[list, str]
    Name of column or list of colunm groups to be groupbed by.
    Each item in the list must work with df.groupby(item), so
    multiple column groups should be in a list themselves, such
    as <code>cols</code> = ['item_id', ['store_id', 'state_id']].
func: callable
    Must work with df.groupby(col)[target].transform(func)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3><p><strong>Poor encoding</strong></p>
<p>Below is the method I used in the competition. I found that the models performed much better during training, and much worse during validation, so I dropped them from training.</p>
<p>I should have done the encoding more carefully, using no future data. I will explore encodings more in the post competition experiments.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_encodings" class="doc_header"><code>fe_encodings</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L447" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_encodings</code>(<strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_out_features</code></strong>:"path to feature folder for output"=<em><code>None</code></em>, <strong><code>start_test</code></strong>:"First day to start nans"=<em><code>1942</code></em>)</p>
</blockquote>
<p>Creates target encoding with mean and std for various columns, with sales after <code>start_test</code>
set to np.nan.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_features: Param('path to feature folder', str)='data/features'
path_out_features: Param('path to feature folder for output', str)='data/features'
    This is mainly to run on kaggle where <code>path_features</code> is set to an input dataset,
    because we need the rolling window stat features to be present, and
    <code>path_out_features</code> is set the working directory for the output.
start_test: Param('First day to start nans', int)=1942</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_encodings</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/fe_enc_mean.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/fe_enc_std.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/fe_enc_special.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lags-and-rolling-features">Lags and rolling features<a class="anchor-link" href="#Lags-and-rolling-features"> </a></h2><blockquote><p>These are the features created from the raw sales data directly.</p>
</blockquote>
<p><strong>Be carefule with lag features.</strong>
We must be mindful that we will not have the same information for all days in forecast horizon. If we want a single model to predict all days, we can only use lagging features from 28 days and older. In order to create one set of features that we can use for all predictions we will do the following:<em> Create all lagging features as if we are building a model for 1 day into the future. So "lag_1" means sales one day before the first day of the prediction horizon. </em> When building a model for the nth day of the horizon, we need to shift the lag features n - 1 extra days. Since we have 30490 time series, We do this by shifting the index of the features by (n - 1) * 30490 so that the lag features for all training and testing data will be lagged by an extra (n - 1) days to keep information aligned properly.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Basic-lag-features">Basic lag features<a class="anchor-link" href="#Basic-lag-features"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before reshaping the data to become a column, 
    we need to shift our rectangle <code>lag_shift</code>
    by prepended the data with np.nans
    to make up for the data we have cut off.
    Therefore, all the d_1 products 
    in grid_df will have np.nan for lag_1. In 
    fact, as we carry out this process for all 
    lag days, rows with sales on d_x will have 
    np.nan values for all lags lag_y where y &gt;= x.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="p">,</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">make_grid_df</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sales_train_evaluation.csv'</span><span class="p">))</span>
<span class="n">grid_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_lag_col" class="doc_header"><code>make_lag_col</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L532" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_lag_col</code>(<strong><code>rec</code></strong>:<code>array</code>, <strong><code>lag</code></strong>:<code>int</code>)</p>
</blockquote>
<p>Transform the 'rectangle' of time series into a lag feature</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rec</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">make_lag_col</span><span class="p">(</span><span class="n">rec</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_lags" class="doc_header"><code>add_lags</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L539" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_lags</code>(<strong><code>grid_df</code></strong>, <strong><code>rec</code></strong>, <strong><code>lags</code></strong>=<em><code>range(1, 16)</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">add_lags</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Pandas-shift">Pandas shift<a class="anchor-link" href="#Pandas-shift"> </a></h4><p>We can also 
just use pandas shift which is easier to implement and not much slower. 
The only downside is that we must use <code>num_series</code>
to shift by the correct increment. 
Here we will do it for g, which was the
same as grid_df before adding lags.
Our time was not wasted though, 
because we learned skills that we will 
need for making rolling windows.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rec</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">g</span><span class="p">,</span> <span class="n">rec_tmp</span> <span class="o">=</span> <span class="n">make_grid_df</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_DATA_RAW</span><span class="p">,</span> <span class="s1">'sales_train_evaluation.csv'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">num_series</span> <span class="o">=</span> <span class="n">df_stv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">g</span><span class="p">[</span><span class="sa">f</span><span class="s1">'lag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">'sales'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">num_series</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">g</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_lags" class="doc_header"><code>fe_lags</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L549" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_lags</code>(<strong><code>path_data_raw</code></strong>:"path to raw data folder"=<em><code>'data/raw'</code></em>, <strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_to_train_file</code></strong>:"path to train data"=<em><code>None</code></em>)</p>
</blockquote>
<p>Creates lags and rolling window features using <a href="/chrisrichardmiles/feature_engineering.html#add_lags"><code>add_lags</code></a> <a href="/chrisrichardmiles/feature_engineering.html#add_rolling_cols"><code>add_rolling_cols</code></a></p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_data_raw: Param('path to raw data folder', str)='data/raw'
path_features: Param('path to feature folder', str)='data/features'
path_to_train_file: Param('path to train data', str)=None
    This is so we can <code>oos_sales_train_evaluation.csv</code> file which is
    the result of filling zero streaks with NaN where we think an item
    is out of stock.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_lags</span><span class="p">()</span>
<span class="c1"># fe_lags(PATH_DATA_RAW, path_features='.')</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">max_lag</span> <span class="o">=</span> <span class="mi">84</span>
<span class="n">cols_per_file</span> <span class="o">=</span> <span class="mi">14</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">,</span> <span class="n">cols_per_file</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_lags_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span> <span class="o">+</span> <span class="n">cols_per_file</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s1">.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Rolling-features">Rolling features<a class="anchor-link" href="#Rolling-features"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="rolling-window-function">rolling window function<a class="anchor-link" href="#rolling-window-function"> </a></h4><p>Please check out 
<a href="https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html">"Efficient rolling statistics with NumPy"</a>
by <a href="https://rigtorp.se/">Erik Rigtorp</a>. 
The article shows some cool numpy tricks to do really fast rolling window calculations by creating "rolling windows views"</p>
<p><strong>Update to the article 2021-04-21:</strong>
"NumPy now comes with a builtin function sliding_window_view that does exactly this. There’s also the Bottleneck library with optimized functions for rolling mean, standard deviation etc."</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="rolling_window" class="doc_header"><code>rolling_window</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L595" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rolling_window</code>(<strong><code>a</code></strong>:<code>array</code>, <strong><code>window</code></strong>:<code>int</code>)</p>
</blockquote>
<p>A super fast way of getting rolling window view with size <code>window</code> on a numpy array.
Reference: <a href="https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html">https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rw</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">rw</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">x</span><span class="p">,</span> <span class="n">rw</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_array" class="doc_header"><code>split_array</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L606" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_array</code>(<strong><code>ary</code></strong>, <strong><code>sections</code></strong>, <strong><code>axis</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>Works just like np.split, but sections must be a
single integer. It will work, even when sections doesn't
evenly divide the length of ary.</p>
<p>This avoids errors that occur when using
<a href="/chrisrichardmiles/feature_engineering.html#make_rolling_col"><code>make_rolling_col</code></a> with high <code>n_splits</code> that do not
divide the number of series evenly.</p>
<h2 id="Examples">Examples<a class="anchor-link" href="#Examples"> </a></h2><blockquote><blockquote><blockquote><p>x = np.arange(9)
split_array(x, 4)
[array([0, 1, 2]), array([3, 4, 5]), array([6, 7, 8])]</p>
<p>split_array(x, 5)
[array([0, 1]), array([2, 3]), array([4, 5]), array([6, 7, 8])]</p>
</blockquote>
</blockquote>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">split_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_rolling_col" class="doc_header"><code>make_rolling_col</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L627" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_rolling_col</code>(<strong><code>rw</code></strong>, <strong><code>function</code></strong>, <strong><code>n_splits</code></strong>=<em><code>10</code></em>)</p>
</blockquote>
<p>Returns a one dimensional np.array after <code>function</code> has been applied to the rolling window view <code>rw</code>.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>rw: a rolling window view as defined in this same module
function: a callable such as np.mean
    Axis must be the second parameter.
n_splits: int
    Must divide rw.shape[0]. This will avoid a RAM overflow
    that can occur when using</p>
<p>We need to take off the last columns to
get the rolling feature shifted one day,
since we are making features for training.
For predicting day 10, we only know the
rolling features up to day 9.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rw</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The shape </span><span class="si">{</span><span class="n">rw</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, represents (num_series, num_windows, window_size)'</span><span class="p">)</span>
<span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">make_rolling_col</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Make sure the shape of the resulting column matches grid_df'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'='</span><span class="p">,</span>  <span class="n">col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rw</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">make_rolling_col</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">rw</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">col</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Some-more-functions-for-rolling-windows">Some more functions for rolling windows<a class="anchor-link" href="#Some-more-functions-for-rolling-windows"> </a></h4><p>These functions are designed to act on a rolling_window array
created by the rolling_window function, similar to np.mean
or np.std.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="diff_mean" class="doc_header"><code>diff_mean</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L656" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>diff_mean</code>(<strong><code>rolling_window</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>)</p>
</blockquote>
<p>For M5 purposes, used on an object generated by the
rolling_window function. Returns the mean of the first
difference of a window of sales.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="diff_nanmean" class="doc_header"><code>diff_nanmean</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L662" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>diff_nanmean</code>(<strong><code>rolling_window</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>)</p>
</blockquote>
<p>For M5 purposes, used on an object generated by the
rolling_window function. Returns the mean of the first
difference of a window of sales.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="mean_decay" class="doc_header"><code>mean_decay</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L668" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mean_decay</code>(<strong><code>rolling_window</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>)</p>
</blockquote>
<p>Returns the mean_decay along an axis of a rolling window object,
which is created by the rolling_window() function.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_rolling_cols" class="doc_header"><code>add_rolling_cols</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L679" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_rolling_cols</code>(<strong><code>grid_df</code></strong>:<code>DataFrame</code>, <strong><code>rec</code></strong>:<code>array</code>, <strong><code>windows</code></strong>:<code>list</code>, <strong><code>functions</code></strong>:<code>list</code>, <strong><code>function_names</code></strong>:<code>list</code>=<em><code>None</code></em>, <strong><code>n_splits</code></strong>:<code>list or int</code>=<em><code>10</code></em>)</p>
</blockquote>
<p>Adds rolling features to grid_df.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span> <span class="o">=</span> <span class="n">add_rolling_cols</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> 
                 <span class="n">rec</span><span class="p">,</span> 
                 <span class="n">windows</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span> 
                 <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">],</span> 
                 <span class="n">function_names</span><span class="o">=</span><span class="p">[</span><span class="s1">'mean'</span><span class="p">,</span> <span class="s1">'std'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_rw_stats" class="doc_header"><code>fe_rw_stats</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L711" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_rw_stats</code>(<strong><code>path_data_raw</code></strong>:"path to raw data folder"=<em><code>'data/raw'</code></em>, <strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_to_train_file</code></strong>:"path to train data"=<em><code>None</code></em>)</p>
</blockquote>
<p>Creates lags and rolling window features using <a href="/chrisrichardmiles/feature_engineering.html#add_lags"><code>add_lags</code></a> <a href="/chrisrichardmiles/feature_engineering.html#add_rolling_cols"><code>add_rolling_cols</code></a></p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_data_raw: Param('path to raw data folder', str)='data/raw'
path_features: Param('path to feature folder', str)='data/features'
path_to_train_file: Param('path to train data', str)=None
    This is so we can <code>oos_sales_train_evaluation.csv</code> file which is
    the result of filling zero streaks with NaN where we think an item
    is out of stock.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_rw_stats</span><span class="p">()</span>
<span class="c1"># fe_rw_stats(PATH_DATA_RAW, path_features='.')</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_rw_1.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_rw_2.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_rw_3.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Average-for-each-day-of-the-week">Average for each day of the week<a class="anchor-link" href="#Average-for-each-day-of-the-week"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Feature-telling-how-long-its-been-since-theres-been-a-sale">Feature telling how long its been since theres been a sale<a class="anchor-link" href="#Feature-telling-how-long-its-been-since-theres-been-a-sale"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_days_since_sale" class="doc_header"><code>get_days_since_sale</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L782" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_days_since_sale</code>(<strong><code>grid_df</code></strong>, <strong><code>num_series</code></strong>=<em><code>30490</code></em>)</p>
</blockquote>
<p>Returns a column that shows how many days its been
Since there has been a sale.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_dow_means" class="doc_header"><code>add_dow_means</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L801" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_dow_means</code>(<strong><code>grid_df</code></strong>, <strong><code>rec</code></strong>, <strong><code>n_weeks</code></strong>)</p>
</blockquote>
<p>Adds features to grid_df for the mean of each day of the week
for the past <code>n_weeks</code>.</p>
<p>For any row, the column 'mean_{n_weeks}<em>dow</em>{i}' represents the mean
of the last <code>n_weeks</code> of sales for the day of the week that is <code>i</code>
days behind the date of this row. So if today is Friday, n_weeks=4
and i = 1, this column is equal to the mean sales of the last 4
Thursdays.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_dow_means" class="doc_header"><code>fe_dow_means</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L818" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_dow_means</code>(<strong><code>path_data_raw</code></strong>:"path to raw data folder"=<em><code>'data/raw'</code></em>, <strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_to_train_file</code></strong>:"path to train data"=<em><code>None</code></em>)</p>
</blockquote>
<p>Creates the features for day of week means using <a href="/chrisrichardmiles/feature_engineering.html#add_dow_means"><code>add_dow_means</code></a></p>
<p>We also use 'get_days_since_sale' in this script since there isn't
another group very similar to this feature.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_data_raw: Param('path to raw data folder', str)='data/raw'
path_features: Param('path to feature folder', str)='data/features'
path_to_train_file: Param('path to train data', str)=None
    This is so we can <code>oos_sales_train_evaluation.csv</code> file which is
    the result of filling zero streaks with NaN where we think an item
    is out of stock.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_dow_means</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_dow_means_and_days_since_sale.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Shifted-lag-rolling-features">Shifted lag rolling features<a class="anchor-link" href="#Shifted-lag-rolling-features"> </a></h2><p>Perhaps I want to also want to know 7 day rolling 
mean, but from 7 seven days ago. This could go 
directly into a model, or we could create a weekly
<code>momentum_7_rolling_mean_7 = shift_1_rolling_mean_7/shift_8_rolling_mean_7</code>. 
We have already calculated these features, 
we just need to shift the columns by <code>num_series * (shift_days - 1)</code>.
We subtract 1 from shift_days because the column shift_1_rolling_mean_7
is already shifted 1 day.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_shift_cols" class="doc_header"><code>add_shift_cols</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L869" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_shift_cols</code>(<strong><code>grid_df</code></strong>:<code>DataFrame</code>, <strong><code>shifts</code></strong>:<code>list</code>, <strong><code>cols</code></strong>:<code>list</code>, <strong><code>num_series</code></strong>:<code>int</code>=<em><code>30490</code></em>, <strong><code>momentum</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Adds shift<em>{<code>shift</code>} and momentum</em>{<code>shift</code> - 1} features for each
int <code>shift</code> in <code>shifts</code> for each column in <code>cols</code>. <code>cols</code> must be
a list of columns that begin with 'shift_1' for this function to work.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">29</span><span class="p">]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'shift_1_rolling_mean_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">]]</span>
<span class="n">add_shift_cols</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">num_series</span><span class="o">=</span><span class="n">df_stv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_shifts_momentum" class="doc_header"><code>fe_shifts_momentum</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L885" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_shifts_momentum</code>(<strong><code>path_features</code></strong>:"path to feature folder"=<em><code>'data/features'</code></em>, <strong><code>path_out_features</code></strong>:"path to feature folder for output"=<em><code>''</code></em>, <strong><code>num_series</code></strong>:"Number of series for shifting"=<em><code>30490</code></em>)</p>
</blockquote>
<p>Creates shifts and momentum features using <a href="/chrisrichardmiles/feature_engineering.html#add_shift_cols"><code>add_shift_cols</code></a></p>
<p>Parameters</p>
<hr>
<p>path_features: Param('path to feature folder', str)='data/features'</p>
<p>path_out_features: Param('path to feature folder for output', str)='data/features'
    This is mainly to run on kaggle where <code>path_features</code> is set to an input dataset,
    because we need the rolling window stat features to be present, and
    <code>path_out_features</code> is set the working directory for the output.</p>
<p>num_series: Param('Number of series for shifting', int)=30490</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># time.sleep(1)</span>
<span class="n">fe_shifts_momentum</span><span class="p">(</span><span class="n">num_series</span><span class="o">=</span><span class="n">df_stv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_shifts_mom_1.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_shifts_mom_2.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_shifts_mom_3.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dimensionality-reduction-of-lags">Dimensionality reduction of lags<a class="anchor-link" href="#Dimensionality-reduction-of-lags"> </a></h2><p>Since we have so many lags, I will try to use pca to reduce the number of features I have. 
I can't fit all the lags into memory, so I will create the pca features iteratively, 
starting with lags 71 through 84, save the file, then save the top 7 components 
to do pca again with lags 57 through 70, and so on until I have 14 pca components 
for lags 1 through 84. Then I can decide how many lags features I want to keep without
reducing their dimension.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe_ipca_lags" class="doc_header"><code>fe_ipca_lags</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L959" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe_ipca_lags</code>(<strong><code>path_data_raw</code></strong>:"path to raw data folder"=<em><code>'data/raw'</code></em>, <strong><code>path_features</code></strong>:"Path to feature file"=<em><code>'data/features'</code></em>, <strong><code>path_to_train_file</code></strong>:"path to train data"=<em><code>None</code></em>, <strong><code>end</code></strong>:"last day to start lags from"=<em><code>1</code></em>, <strong><code>restart</code></strong>:"start if resuming with lags_df.pkl in restart_dir"=<em><code>None</code></em>, <strong><code>target</code></strong>:"Name of target column"=<em><code>'sales'</code></em>)</p>
</blockquote>
<p>Creates ipca columns for 84 lag days, starting from the end
and accumulating backward. With 16 GB of RAM, we can only fit 14
with ipca at a time, so for each iteration, we:</p>

<pre><code>1) Create 14 new lag days, and use ipca to reduce it to
the top 7 compnents.
2) Combine those with the top 7 components from the previous step
3) Perform ipca on these 14, features, save the output, and
keep the top 7 components for the next iteration.

</code></pre>
<p>In the end we will have files with the top 14 ipca components
for each of these separate ranges:
Days 1_84
Days 15_84
Days 29_84
Days 43_84
Days 57_84
Days 71_84</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>path_data_raw: Param('path to raw data folder', str)='data/raw',
path_features: Param('path to feature folder', str)='data/features'
path_to_train_file: Param('path to train data', str)=None
    This is so we can use <code>oos_sales_train_evaluation.csv</code> file which is
    the result of filling zero streaks with NaN where we think an item
    is out of stock.
target: Param('Name of target column', str)='sales'</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fe_ipca_lags</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_1_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_15_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_29_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_43_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_57_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">load_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">PATH_DATA_FEATURES</span><span class="si">}</span><span class="s1">/shift_fe_ipca_71_84.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lets-see-all-the-features-we-created">Lets see all the features we created<a class="anchor-link" href="#Lets-see-all-the-features-we-created"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_file_cols_dict</span><span class="p">(</span><span class="n">PATH_DATA_FEATURES</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>rm data/features/*csv
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Make-all-features">Make all features<a class="anchor-link" href="#Make-all-features"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="fe" class="doc_header"><code>fe</code><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/tree/master/chrisrichardmiles/m5/fe.py#L1073" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fe</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span><span class="p">;</span> <span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>


