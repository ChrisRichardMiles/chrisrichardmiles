<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>../../chrisrichardmiles - Optiver Realized Volatility Prediction: 91st place solution</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="../../chrisrichardmiles - Optiver Realized Volatility Prediction: 91st place solution">
<meta property="og:description" content="Predictions of the volatility of stock prices over the next 10 minute window, given trading data and book data.">
<meta property="og:image" content="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/optiver/index_optiver_files/figure-html/optiver_feature_importance_gain.png">
<meta property="og:site-name" content="../../chrisrichardmiles">
<meta property="og:image:height" content="603">
<meta property="og:image:width" content="1213">
<meta name="twitter:title" content="../../chrisrichardmiles - Optiver Realized Volatility Prediction: 91st place solution">
<meta name="twitter:description" content="Predictions of the volatility of stock prices over the next 10 minute window, given trading data and book data.">
<meta name="twitter:image" content="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/optiver/index_optiver_files/figure-html/optiver_feature_importance_gain.png">
<meta name="twitter:image-height" content="603">
<meta name="twitter:image-width" content="1213">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">chrisrichardmiles</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Optiver Realized Volatility Prediction: 91st place solution</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">chrisrichardmiles</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../core.html" class="sidebar-item-text sidebar-link">Core</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">projects</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">m5</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/index_m5.html" class="sidebar-item-text sidebar-link">Welcome to chrisrichardmiles.m5</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/brief_eda.html" class="sidebar-item-text sidebar-link">Brief EDA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/feature_engineering.html" class="sidebar-item-text sidebar-link">Feature engineering</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/04_out_of_stock_detection.html" class="sidebar-item-text sidebar-link">Total sales for all series of aggregation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/training_day_by_day_models.html" class="sidebar-item-text sidebar-link">Train day-by-day models</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">optiver</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/index_optiver.html" class="sidebar-item-text sidebar-link active">Optiver Realized Volatility Prediction: 91st place solution</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/opt-error-analysis.html" class="sidebar-item-text sidebar-link">Error analysis</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">notebooks</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-book-trade-eda.html" class="sidebar-item-text sidebar-link">price features</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-eda-modified-from-host-nb.html" class="sidebar-item-text sidebar-link">Optiver Realized Volatility Prediction</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart-op-129a-stock-31-only.html" class="sidebar-item-text sidebar-link">opt-train-dart-op-129a-stock-31-only.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart.html" class="sidebar-item-text sidebar-link">opt-train-dart.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-one-at-a-time.html" class="sidebar-item-text sidebar-link">opt-train-one-at-a-time.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-tabnet-142.html" class="sidebar-item-text sidebar-link">opt-train-tabnet-142.html</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-does-the-competition-host-want" id="toc-what-does-the-competition-host-want" class="nav-link active" data-scroll-target="#what-does-the-competition-host-want">What does the competition host want?</a></li>
  <li><a href="#why-volatility" id="toc-why-volatility" class="nav-link" data-scroll-target="#why-volatility">Why volatility?</a>
  <ul class="collapse">
  <li><a href="#how-to-determine-an-options-value" id="toc-how-to-determine-an-options-value" class="nav-link" data-scroll-target="#how-to-determine-an-options-value">How to determine an options value</a></li>
  </ul></li>
  <li><a href="#precisely-what-are-we-being-asked-to-predict" id="toc-precisely-what-are-we-being-asked-to-predict" class="nav-link" data-scroll-target="#precisely-what-are-we-being-asked-to-predict">Precisely, what are we being asked to predict?</a>
  <ul class="collapse">
  <li><a href="#realized-volatility" id="toc-realized-volatility" class="nav-link" data-scroll-target="#realized-volatility">realized volatility</a></li>
  <li><a href="#log-returns" id="toc-log-returns" class="nav-link" data-scroll-target="#log-returns">Log returns</a></li>
  </ul></li>
  <li><a href="#how-will-our-predictions-be-scored" id="toc-how-will-our-predictions-be-scored" class="nav-link" data-scroll-target="#how-will-our-predictions-be-scored">How will our predictions be scored?</a></li>
  <li><a href="#what-does-the-input-data-look-like-at-the-time-of-prediction" id="toc-what-does-the-input-data-look-like-at-the-time-of-prediction" class="nav-link" data-scroll-target="#what-does-the-input-data-look-like-at-the-time-of-prediction">What does the input data look like at the time of prediction?</a>
  <ul class="collapse">
  <li><a href="#book_test.parque" id="toc-book_test.parque" class="nav-link" data-scroll-target="#book_test.parque">book_test.parque</a></li>
  <li><a href="#trade_test.parquet" id="toc-trade_test.parquet" class="nav-link" data-scroll-target="#trade_test.parquet">trade_test.parquet</a></li>
  <li><a href="#test.csv" id="toc-test.csv" class="nav-link" data-scroll-target="#test.csv">test.csv</a></li>
  </ul></li>
  <li><a href="#my-solution" id="toc-my-solution" class="nav-link" data-scroll-target="#my-solution">My solution</a>
  <ul class="collapse">
  <li><a href="#models" id="toc-models" class="nav-link" data-scroll-target="#models">Models</a></li>
  <li><a href="#features" id="toc-features" class="nav-link" data-scroll-target="#features">Features</a></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation">Validation</a></li>
  </ul></li>
  <li><a href="#how-to-reproduce-results" id="toc-how-to-reproduce-results" class="nav-link" data-scroll-target="#how-to-reproduce-results">How to reproduce results</a>
  <ul class="collapse">
  <li><a href="#simple-model-reproduction-locally-from-scratch" id="toc-simple-model-reproduction-locally-from-scratch" class="nav-link" data-scroll-target="#simple-model-reproduction-locally-from-scratch">Simple model reproduction locally from scratch</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Optiver Realized Volatility Prediction: 91st place solution</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<ul>
<li><a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/overview">Competition website</a></li>
<li><a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/overview/evaluation">Evaluation details</a></li>
<li><a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/data">Data details</a></li>
<li><a href="https://www.kaggle.com/code/chrisrichardmiles/opt-inf-ensemble-final-1">My submission</a>: Being a code competition, all submissions must be made online through the kaggle website.</li>
<li><a href="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/optiver/index_optiver.html#my-solution">Solution description</a></li>
<li><a href="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/optiver/index_optiver.html#how-to-reproduce-results">Reproduce full solution on kaggle</a></li>
<li><a href="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/optiver/index_optiver.html#simple-model-reproduction-locally-from-scratch">Reproduce best single model locally</a></li>
<li><a href="https://github.com/ChrisRichardMiles/chrisrichardmiles/tree/bc766f27d424f5adcc2471e6e160fcff9739bb2d/projects/optiver">Code on github</a></li>
</ul>
<section id="what-does-the-competition-host-want" class="level2">
<h2 class="anchored" data-anchor-id="what-does-the-competition-host-want">What does the competition host want?</h2>
<p>Predictions of the volatility of stock prices over the next 10 minute window, given trading data and book data.</p>
</section>
<section id="why-volatility" class="level2">
<h2 class="anchored" data-anchor-id="why-volatility">Why volatility?</h2>
<p>Volatility is important because it is used in calculating the value of a stock option. We can trade more profitably if we are better at determining value.</p>
<section id="what-are-options-and-strike-prices" class="level4">
<h4 class="anchored" data-anchor-id="what-are-options-and-strike-prices">What are options and strike prices?</h4>
<ul>
<li>An options contract offers the buyer the opportunity to buy or sell—depending on the type of contract they hold—the underlying asset at a certain strike price. Read more about <a href="An%20options%20contract%20offers%20the%20buyer%20the%20opportunity%20to%20buy%20or%20sell—depending%20on%20the%20type%20of%20contract%20they%20hold—the%20underlying%20asset">options</a> and <a href="https://www.investopedia.com/terms/s/strikeprice.asp#:~:text=Key%20Takeaways%201%20The%20strike%20price%20on%20an,an%20option%20is%20%E2%80%9Cin-the-money%E2%80%9D%20or%20%E2%80%9Cout-of-the-money.%22%20More%20items">strike prices</a>.</li>
</ul>
</section>
<section id="how-to-determine-an-options-value" class="level3">
<h3 class="anchored" data-anchor-id="how-to-determine-an-options-value">How to determine an options value</h3>
<p>Fundamentally, this is the basic equation for an options value.</p>
<p><span class="math display">\[
\textrm{option value} = \textrm{intrinsic value} + \textrm{time value}
\]</span></p>
<p>Intrinsic value is just the difference between the current price of a stock and the strike price of an option for that stock, so it is known at the time of sale. To calculate the time value, one would need to know the probability distribution of a stock price at the expiration time of the option. The volatility of a stock’s price will affect that distribution since a stock with high volatility will have larger price changes over time. Therefore, if we can better predict the volatility of a stock, we can trade options more profitably.</p>
<p>Their is more rigorous math involved in determining an options value, including the famous <a href="https://www.investopedia.com/terms/b/blackscholes.asp">Black Scholes equation</a>, but for this project, it is sufficient to understand that the volatility plays a key role in option pricing.</p>
</section>
</section>
<section id="precisely-what-are-we-being-asked-to-predict" class="level2">
<h2 class="anchored" data-anchor-id="precisely-what-are-we-being-asked-to-predict">Precisely, what are we being asked to predict?</h2>
<section id="realized-volatility" class="level3">
<h3 class="anchored" data-anchor-id="realized-volatility">realized volatility</h3>
<p>We will compute the log returns over all consecutive book updates and we define the <strong>realized volatility, <span class="math inline">\(\sigma\)</span>,</strong> as the squared root of the sum of squared log returns. <span class="math display">\[
\sigma = \sqrt{\sum_{t}r_{t-1, t}^2}
\]</span></p>
</section>
<section id="log-returns" class="level3">
<h3 class="anchored" data-anchor-id="log-returns">Log returns</h3>
<p>Calling <span class="math inline">\(S_t\)</span> the price of the stock <span class="math inline">\(S\)</span> at time <span class="math inline">\(t\)</span>, we can define the log return between <span class="math inline">\(t_1\)</span> and <span class="math inline">\(t_2\)</span> as: <span class="math display">\[
r_{t_1, t_2} = \log \left( \frac{S_{t_2}}{S_{t_1}} \right)
\]</span> Where we use <strong>WAP</strong> (Weighted Average Price) as price of the stock to compute log returns. <span class="math display">\[ WAP = \frac{BidPrice_{1}*AskSize_{1} + AskPrice_{1}*BidSize_{1}}{BidSize_{1} + AskSize_{1}} \]</span> where an order book looks like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.optiver.com/wp-content/uploads/2021/05/OrderBook3.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">order_book_1</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="how-will-our-predictions-be-scored" class="level2">
<h2 class="anchored" data-anchor-id="how-will-our-predictions-be-scored">How will our predictions be scored?</h2>
<p>Submissions are evaluated using the root mean square percentage error, defined as:</p>
<p><span class="math display">\[\text{RMSPE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} ((y_i - \hat{y}_i)/y_i)^2}\]</span></p>
<p>There will be around 100 stock ids in the test set and around 150,000 rows to predict. With <code>row_id</code> reffering to “stock_id”-“time_id”, the submission file looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(sample_submission.to_markdown())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;"></th>
<th style="text-align: left;">row_id</th>
<th style="text-align: right;">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">0-4</td>
<td style="text-align: right;">0.00304802</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">0-32</td>
<td style="text-align: right;">0.00304802</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">0-34</td>
<td style="text-align: right;">0.00304802</td>
</tr>
</tbody>
</table>
</section>
<section id="what-does-the-input-data-look-like-at-the-time-of-prediction" class="level2">
<h2 class="anchored" data-anchor-id="what-does-the-input-data-look-like-at-the-time-of-prediction">What does the input data look like at the time of prediction?</h2>
<section id="book_test.parque" class="level3">
<h3 class="anchored" data-anchor-id="book_test.parque">book_test.parque</h3>
<p>A parquet file partitioned by stock_id. Provides order book data on the most competitive buy and sell orders entered into the market. The top two levels of the book are shared. The first level of the book will be more competitive in price terms, it will then receive execution priority over the second level.</p>
<p>Here are the first few rows of the book data for stock_id 0:</p>
<!-- stock_id - ID code for the stock. Not all stock IDs exist in every time bucket. Parquet coerces this column to the categorical data type when loaded; you may wish to convert it to int8.
time_id - ID code for the time bucket. Time IDs are not necessarily sequential but are consistent across all stocks.
seconds_in_bucket - Number of seconds from the start of the bucket, always starting from 0.
bid_price[1/2] - Normalized prices of the most/second most competitive buy level.
ask_price[1/2] - Normalized prices of the most/second most competitive sell level.
bid_size[1/2] - The number of shares on the most/second most competitive buy level.
ask_size[1/2] - The number of shares on the most/second most competitive sell level. -->
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(book_test.to_markdown())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<colgroup>
<col style="width: 2%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;"></th>
<th style="text-align: right;">time_id</th>
<th style="text-align: right;">seconds_in_bucket</th>
<th style="text-align: right;">bid_price1</th>
<th style="text-align: right;">ask_price1</th>
<th style="text-align: right;">bid_price2</th>
<th style="text-align: right;">ask_price2</th>
<th style="text-align: right;">bid_size1</th>
<th style="text-align: right;">ask_size1</th>
<th style="text-align: right;">bid_size2</th>
<th style="text-align: right;">ask_size2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00005</td>
<td style="text-align: right;">1.00059</td>
<td style="text-align: right;">0.999656</td>
<td style="text-align: right;">1.00064</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.00005</td>
<td style="text-align: right;">1.00059</td>
<td style="text-align: right;">0.999656</td>
<td style="text-align: right;">1.00064</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1.00005</td>
<td style="text-align: right;">1.00064</td>
<td style="text-align: right;">0.999656</td>
<td style="text-align: right;">1.00089</td>
<td style="text-align: right;">290</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">15</td>
</tr>
</tbody>
</table>
</section>
<section id="trade_test.parquet" class="level3">
<h3 class="anchored" data-anchor-id="trade_test.parquet">trade_test.parquet</h3>
<p>A parquet file partitioned by stock_id. Contains data on trades that actually executed. Usually, in the market, there are more passive buy/sell intention updates (book updates) than actual trades, therefore one may expect this file to be more sparse than the order book.</p>
<p>Here are the first few rows of the trade data for stock_id 0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(trade_test.to_markdown())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 16%">
<col style="width: 30%">
<col style="width: 13%">
<col style="width: 11%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;"></th>
<th style="text-align: right;">time_id</th>
<th style="text-align: right;">seconds_in_bucket</th>
<th style="text-align: right;">price</th>
<th style="text-align: right;">size</th>
<th style="text-align: right;">order_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00034</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1.00005</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">1.00006</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</section>
<section id="test.csv" class="level3">
<h3 class="anchored" data-anchor-id="test.csv">test.csv</h3>
<p>Provides the mapping between the other data files and the submission file. As with other test files, most of the data is only available to your notebook upon submission with just the first few rows available for download.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(test.to_markdown())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;"></th>
<th style="text-align: right;">stock_id</th>
<th style="text-align: right;">time_id</th>
<th style="text-align: left;">row_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">0-4</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">32</td>
<td style="text-align: left;">0-32</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">0-34</td>
</tr>
</tbody>
</table>
<section id="important-notes-about-the-data" class="level4">
<h4 class="anchored" data-anchor-id="important-notes-about-the-data">Important notes about the data:</h4>
<ul>
<li><p>As stated on the <a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/data">data page</a>, Time IDs are not necessarily sequential but are consistent across all stocks. This is very important information. It means we can use information from all stocks in a given time_id, but can’t create lagging features since we can’t order the data by time. However, this turned out not to be completely true. The winner of the competiton used the price tick size to reverse engineer the order of the time_ids, as stated in their write up: <a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/discussion/274970">https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/discussion/274970</a>. I did not use this technique in my solution.</p></li>
<li><p>Data for all time_ids are given in one batch, instead of sequentially. This is not how predictions are made in the real world, where you need to make predictions and act on them before you have any data from the future. Even though the time_ids are shuffled, we can still use aggregated information accross all time_ids when making predictions. I did take advantage of this in my solution by aggregating data across all time_ids.</p></li>
</ul>
</section>
</section>
</section>
<section id="my-solution" class="level2">
<h2 class="anchored" data-anchor-id="my-solution">My solution</h2>
<p>I used gradient boosted tree based models and neural networks. For gradient boosting, I used the <a href="https://lightgbm.readthedocs.io/en/v3.3.2/">Lightgbm</a> implementation, using both standard gradient boosting and dart mode. For the neural networks, I used the tabnet architecture, implemented by <a href="https://github.com/Optimox">Optimo</a>, at this repository: <a href="https://github.com/dreamquark-ai/tabnet">https://github.com/dreamquark-ai/tabnet</a>.</p>
<ul>
<li>Dart paper: <a href="https://arxiv.org/pdf/1505.01866.pdf">https://arxiv.org/pdf/1505.01866.pdf</a> K. V. Rashmi, Ran Gilad-Bachrach (2015)</li>
<li>Tabnet paper: <a href="https://arxiv.org/pdf/1908.07442.pdf">https://arxiv.org/pdf/1908.07442.pdf</a> Arik, S. O., &amp; Pfister, T. (2019)</li>
</ul>
<p>My final submission is a blend of predictions from 10 different models. The blend is 1/2(weighted arithmetic mean) + 1/2(weighted geometric mean). The weights are determined using the <a href="https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.optimize.minimize.html">minimize</a> function from scipy. All models have the same input features, generated by the <a href="https://github.com/ChrisRichardMiles/chrisrichardmiles/blob/bc766f27d424f5adcc2471e6e160fcff9739bb2d/projects/optiver/opt_fe.py#L707"><code>p13</code></a> function in fe.py.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_optiver_files/figure-html/optiver_model_diagram_cropped.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">optiver_model_diagram_cropped.png</figcaption><p></p>
</figure>
</div>
<section id="models" class="level3">
<h3 class="anchored" data-anchor-id="models">Models</h3>
<section id="regular-models-trained-with-5-fold-cross-validation." class="level4">
<h4 class="anchored" data-anchor-id="regular-models-trained-with-5-fold-cross-validation.">Regular models trained with 5-fold cross validation.</h4>
<ul>
<li>dart: lightgbm model with dart mode, using <code>lgb_params</code></li>
<li>dart_175: lightgbm model with dart mode, using <code>dart_175_params</code></li>
<li>tab: tabnet model with <code>tabnet_params</code></li>
<li>tab_181: same as tab, except <code>T_0</code> is changed from 200 to 30 in <code>scheduler_params</code></li>
<li>tab_183: same as tab_181 except <code>n_steps</code> is changed from 2 to 3.</li>
</ul>
</section>
<section id="nested-models-trained-with-nested-cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="nested-models-trained-with-nested-cross-validation">Nested models trained with nested cross validation</h4>
<ul>
<li>tab_nested: same as tab, but nested cv.</li>
<li>dart_nested: same as dart, but nested cv.</li>
<li>dart_175_nested: same as dart_175, but nested cv.</li>
</ul>
</section>
<section id="level-2-models" class="level4">
<h4 class="anchored" data-anchor-id="level-2-models">Level 2 models:</h4>
<p>These models have the same features as the previous models, except with added predictions from tab_nested and dart_nested * dart_l2: same params as dart * lgb_l2: same as dart_l2, except <code>boosting_type</code>=<code>gbdt</code></p>
</section>
<section id="parameters" class="level4">
<h4 class="anchored" data-anchor-id="parameters">Parameters</h4>
<pre><code>lgb_params = {
        "boosting_type": "dart",
        "objective": "rmse",
        "learning_rate": .05,
        "num_leaves": 255,
        "min_data_in_leaf": 255,
        "feature_fraction": 0.8,
        "bagging_fraction": .5,
        "bagging_freq": 1,      
        "n_estimators": 10_000,
        "early_stopping_rounds": 400,
        "n_jobs": -1,
        "seed": 42,
        "verbose": -1, 
    }
    
dart_175 = {
        "boosting_type": "dart",
        "objective": "rmse",
        "learning_rate": .05,
        "num_leaves": 255,
        "min_data_in_leaf": 2 ** 10,
        "feature_fraction": 0.25,
        "bagging_fraction": .85, 
        "bagging_freq": 1,      
        "n_estimators": 10_000,
        "early_stopping_rounds": 400,
        "n_jobs": -1,
        "seed": 42,
        "verbose": -1, 
    }
    
tabnet_params = {
        'cat_emb_dim': 1,
        'n_d': ND_NA,
        'n_a': ND_NA,
        'n_steps': 2,
        'gamma': 2,
        'n_independent': 2,
        'n_shared': 2,
        'lambda_sparse': 0,
        'optimizer_fn': Adam,
        'optimizer_params': {'lr': 0.02},
        'mask_type': 'entmax',
        'scheduler_params': {
            'T_0': 200,
            'T_mult': 1,
            'eta_min': 0.0001,
            'last_epoch': -1,
            'verbose': False
        }</code></pre>
</section>
</section>
<section id="features" class="level3">
<h3 class="anchored" data-anchor-id="features">Features</h3>
<section id="top-25-features" class="level4">
<h4 class="anchored" data-anchor-id="top-25-features">Top 25 features</h4>
<p>This figure is taken from a dart model trained on a single fold. Standard lightgbm models and tabnet models also showed similar feature importance, with slight variations. <img src="index_optiver_files/figure-html/optiver_feature_importance_gain.png" class="img-fluid" alt="optiver_feature_importance_gain.png"></p>
<p><strong>Meaning of commonly used strings in features</strong></p>
<ul>
<li><p><code>{time_id or stock_id}_{feature}_{mean or std}</code> means that we encoded the mean or standard deviation of <code>feature</code> onto each time_id or stock_id</p></li>
<li><p><code>{feature}_mean_decay</code>: Exponentially weighted mean of <code>feature</code>, with later data being higher weighted.</p></li>
<li><p><code>{feature}_mean_decay_flip</code>: Exponentially weighted mean of <code>feature</code>, with earlier data being higher weighted.</p></li>
<li><p><code>{feature}_momentum</code> = <code>{feature}_mean_decay</code> / <code>{feature}_mean_decay_flip</code>.</p></li>
</ul>
<p><strong>Top 25 feature summary</strong></p>
<ul>
<li><strong><code>real_vol_mean_decay_{decay factor}_{decay direction}</code></strong>: This is a weighted average of the features <code>real_vol_min_{minute x of range(0,9)}</code>. The weights are exponentially weighted by the “decay factor”. The weight of the ith minute has a weight of (decay factor) ^ i. The “decay direction” indicates if the highest weight is at the beginning (1) or at the end (-1).</li>
<li><strong><code>real_vol_mean_decay_{decay factor}_{decay direction}_2</code></strong>: Just like the last feature, but using the weighted average price of the second level bid and ask book information.</li>
<li><strong><code>real_vol_min_{minute x of range(0,9)}</code></strong>: The realized volatility calculated for each minute of the 10 minutes of input data.</li>
<li><strong><code>abs_log_return_std</code></strong>: Standard deviation of the absolute value of the log of the return = abs(log(price1 / price0)).</li>
<li><strong><code>time_id_order_norm_mean_decay_mean</code></strong>: <code>order_norm</code> is the order count, normalized by the average order count for the stock_id.</li>
<li><strong><code>time_id_abs_price_wap_diff_mean_decay_mean</code></strong>: <code>abs_price_wap_diff</code> is the absolute difference between the weighted average price and the price of a trade.</li>
<li><strong><code>time_id_spread_momentum_mean</code></strong>: <code>spread</code> is the difference between the ask price and bid price of the first level in the book data.</li>
<li><strong><code>time_id_spread_pct_momentum_mean</code></strong>: <code>spread_pct</code> = <code>spread</code> / <code>wap</code> (weighted average price)</li>
<li><strong><code>time_id_order_norm_sum_mean</code></strong>: <code>order_norm_sum</code> is the sum of <code>order_norm</code>. <code>order_norm</code> is the order count, normalized by the average order count for the stock_id.</li>
<li><strong><code>abs_log_return_mean_decay</code></strong>: Absolute value of the log of the return = abs(log(price1 / price0)).</li>
<li><strong><code>time_id_real_vol_ratio_5_10_mean</code></strong>: <code>real_vol_ratio_5_10</code> is sum_0_5 / sum_6_10, where sum_0_5 is the sum of <code>real_vol_min_{x}</code> for x in the range 1 to 5 and sum_6_10 is the sum of <code>real_vol_min_{x}</code> for x in the range 6 to 10.</li>
<li><strong><code>time_id_real_vol_ratio_5_10_std</code></strong>: <code>real_vol_ratio_5_10</code> is sum_0_5 / sum_6_10, where sum_0_5 is the sum of <code>real_vol_min_{x}</code> for x in the range 1 to 5 and sum_6_10 is the sum of <code>real_vol_min_{x}</code> for x in the range 6 to 10.</li>
<li><strong><code>time_id_spread_2_mean_decay_95_mean</code></strong>: <code>spread_2</code> is the difference between the ask price and bid price of the <strong>second</strong> level in the book data.</li>
<li><strong><code>time_id_order_count_sum_mean</code></strong>: <code>order_count_sum</code> is total number of unique orders made in the 10 minute window of input data in a row.</li>
</ul>
</section>
<section id="feature-creation-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="feature-creation-pipeline">Feature creation pipeline</h4>
<ol type="1">
<li>Create features for an individual stock with a function <code>p{x}</code> (<code>p13</code> was the final function used).</li>
<li>Encode mean and standard deviation of selected features onto the categorical features time_id and stock_id.</li>
<li>Remove time_id and stock_id.
<ul>
<li>time_ids would be bad features because they never appear in both train data and testing data. I also didn’t want to use stock_id because I figured I could easily overfit to training data. By encoding the information and dropping time_id and stock_id, I think the models can be made more robust to shifts in data distribution.</li>
</ul></li>
</ol>
<section id="p13-preprocessing-function-steps" class="level5">
<h5 class="anchored" data-anchor-id="p13-preprocessing-function-steps"><code>p13</code> preprocessing function steps:</h5>
<ol type="1">
<li>Load and merge book data and trade data.</li>
<li>Calculate base features for each row (600 total, one per second over 10 minutes).</li>
<li>Aggregate base features over the full 10 minutes of each time_id to get one row of data per time_id/stock_id combination. Aggregate functions include max_minus_min, mean, std, sum, mean_decay.</li>
<li>Create features by combining aggregate features such as f1 - f2, f1 / f2, f1 + f3.</li>
<li>Add three <code>dummy_x</code> features that are random gaussian noise. These are used to identify features that are not more useful than random noise.</li>
</ol>
</section>
<section id="encoding-using-encode_cols" class="level5">
<h5 class="anchored" data-anchor-id="encoding-using-encode_cols">Encoding using <code>encode_cols</code>:</h5>
<p>I create <code>tmp</code> by encoding the mean or standard deviation of selected features onto time_id and stock_id. For the training data, I then use the <code>shake_std</code> variable to add random noise sampled from a gaussian distribution, whose standard deviation is eqaul to <code>shake_std</code> * (standard deviation of <code>tmp</code>). With <code>shake_std</code>=.3, I was able to obtain the same boost in cv score as I obtained with <code>shake_std</code>=0, but with a smaller difference between the training score and validation score. I did not add noise to the test data.</p>
<p>I did not find using <code>shake</code>, which uses the mean of <code>tmp</code> to scale the noise distribution, to be as usefull as <code>shake_std</code>.</p>
<pre><code>def encode_cols(df, cols, funcs=['mean', 'std'], on='stock_id', shake=False, shake_std=False): 
    if not cols or not funcs: return df
    tmp = df.groupby(on)[cols].agg(funcs)
    tmp.columns = ['_'.join(c) for c in tmp.columns]
    tmp = tmp.add_prefix(on + '_')
    tmp =  df.join(tmp, on=on)
    if shake: 
        for c in tmp.columns: 
            if c.startswith(on + '_'):
                c_mean = tmp[c].mean()
                tmp[c] = tmp[c] + np.random.normal(scale=abs(c_mean * shake), size=len(tmp))
                
    if shake_std: 
        for c in tmp.columns: 
            if c.startswith(on + '_'):
                c_std = tmp[c].std()
                tmp[c] = tmp[c] + np.random.normal(scale=c_std * shake_std, size=len(tmp))
    return tmp </code></pre>
</section>
</section>
</section>
<section id="validation" class="level3">
<h3 class="anchored" data-anchor-id="validation">Validation</h3>
<p>I used k-fold cross validaton with early stopping on the validation set.</p>
<p><strong>Information leakage</strong>: General term talking about a model that is trained with information advantages not given to the model when predicting unseen data, causing it to perform badly. For instance, if we encode a categorical variabl</p>
<p><strong>Choices for early stopping</strong>: 1. Use train/validation split for each fold and early stop on validation set. * Pros: We risk overfitting on the validation sets. * Cons: Faster experiments and I believe this is the best way to find the best “fit”</p>
<ol start="2" type="1">
<li>Use choice 1 and then retrain one model on the entire train set with the average (mean or median) number of iterations (no validation set).</li>
</ol>
<ul>
<li>Pros: We get to use all the training data at the same time.</li>
<li>Cons: With only one model, the risk that we missed the optimal number of training iterations.</li>
</ul>
<ol start="3" type="1">
<li>Use nested k fold, with early stopping on the inner loop.</li>
</ol>
<ul>
<li>Pros: We get the “proper fit” benefit of early stopping, but our out-of-fold predictions can be made without any data leakage, which makes our cv score a more realistic estimation of errors in production. We can also use these prediction as features in other models (model stacking) since the predictions aren’t made with information leakage.</li>
</ul>
<ol start="3" type="1">
<li>No early stopping and use large number of iterations with shrinking learning rate and or regularization. I have little experience with this but I believe it is better suited to neural networks rather than gradient boosted trees.</li>
</ol>
<p>In this competition I tested 1 vs 2 using both nested k-fold test sets and the public test set as validation. I found that 1 gave better results, even when I tried using a variation of 2, using many num_iterations to retrain models, which increased computation cost but didn’t improve metric.</p>
<p>I also tried</p>
<section id="k-fold-cross-validation-brief-explanation" class="level4">
<h4 class="anchored" data-anchor-id="k-fold-cross-validation-brief-explanation">K-fold cross validation brief explanation:</h4>
<p>We divide the data into k equally sized “folds”. For each fold, we use the data in that fold as a validation set and use the remaining data to train a model. So for each set of hyperparameters (model, features, settings etc…) we train k models. When predicting a test set or production set of data, we take an average of all k model predictions.</p>
<ul>
<li><strong>Note on early stopping</strong>: When we are training models, we can choose to use the validation set to choose the optimal number of training iterations (number of tree boosters for gradient boosting and number of epochs for neural nets). This comes at the risk of overconfident cross validation scores. we can also retrain a single model with all the data for training, using the average number of iterations found with early stopping. After a few experiments, judging the outcome by nested cross validation score and the public leaderboard score, I found that using early stopping worked best in this competition.</li>
</ul>
</section>
<section id="nested-cross-validation-brief-explanation" class="level4">
<h4 class="anchored" data-anchor-id="nested-cross-validation-brief-explanation">Nested cross validation brief explanation:</h4>
<p>This method of cross validation allows us to get out of fold predictions on a validation set, but use a separate validation set for early stopping. The benefit is that our cross validation predictions are not “overfit” due to early stopping on the same data, giving more robust validation as well as providing features that can be used for model stacking. The drawback of this method is that you must create k * (k - 1) models, instead of just k models needed for regular k-fold cross validation. * <strong>example with 5 folds</strong>: To obtain predictions for fold_5, I train 4 models and take a mean of their predictions. Each model sees 3 of the 4 remaining folds as training data with the remaining fold is a validation set for early stopping. The training/validaton splits look like [123|4], [124|3], [134|2], [234|1].</p>
</section>
</section>
</section>
<section id="how-to-reproduce-results" class="level2">
<h2 class="anchored" data-anchor-id="how-to-reproduce-results">How to reproduce results</h2>
<p>To predict on the final test data, you must make a submission through kaggle.</p>
<p>The script that produces the final predictions for competition test set: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-inf-ensemble-final-1/notebook?scriptVersionId=75800583">https://www.kaggle.com/code/chrisrichardmiles/opt-inf-ensemble-final-1/notebook?scriptVersionId=75800583</a></p>
<p>The last link is to the last step in the pipeline. All of the model training scripts are public. They can be found in the input section of that notebook, also linked here: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-inf-ensemble-final-1/data?scriptVersionId=75800583">https://www.kaggle.com/code/chrisrichardmiles/opt-inf-ensemble-final-1/data?scriptVersionId=75800583</a></p>
<p>The rest of the pipeline is also public:</p>
<ul>
<li>Feature generation: <a href="https://www.kaggle.com/chrisrichardmiles/generate-train-features-script-p13">https://www.kaggle.com/chrisrichardmiles/generate-train-features-script-p13</a></li>
<li>Module opt_fe.py: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-fe">https://www.kaggle.com/code/chrisrichardmiles/opt-fe</a></li>
<li>Module opt_utils.py: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-utils">https://www.kaggle.com/code/chrisrichardmiles/opt-utils</a></li>
</ul>
<section id="simple-model-reproduction-locally-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="simple-model-reproduction-locally-from-scratch">Simple model reproduction locally from scratch</h3>
<ul>
<li>Requirements: 16 GB of RAM and minconda installed</li>
</ul>
<p>I have provided a script that will process the raw input data into training features and train one of the best single models which scores 0.21986 rmspe on the test set and would place 177th in the competition.</p>
<section id="th-place-simple-model-kaggle-submission" class="level4">
<h4 class="anchored" data-anchor-id="th-place-simple-model-kaggle-submission">177th place simple model kaggle submission</h4>
<ul>
<li>Training: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-train-dart-op-175-fold-0/notebook">https://www.kaggle.com/code/chrisrichardmiles/opt-train-dart-op-175-fold-0/notebook</a></li>
<li>Submission: <a href="https://www.kaggle.com/code/chrisrichardmiles/opt-best-dart-inference/notebook">https://www.kaggle.com/code/chrisrichardmiles/opt-best-dart-inference/notebook</a></li>
</ul>
</section>
<section id="instructions-to-build-model-locally" class="level4">
<h4 class="anchored" data-anchor-id="instructions-to-build-model-locally">Instructions to build model locally</h4>
<ul>
<li>Clone this repository and navigate to the optiver directory:</li>
</ul>
<pre><code>git clone https://github.com/ChrisRichardMiles/chrisrichardmiles.git
cd chrisrichardmiles/projects/optiver</code></pre>
<ul>
<li>The competition data can be found here: <a href="https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/data">https://www.kaggle.com/competitions/optiver-realized-volatility-prediction/overview/evaluation</a></li>
<li>Download data into the input folder. If you have the kaggle api installed, with your kaggle.json file in /root/.kaggle, you can run the following:</li>
</ul>
<pre><code>kaggle competitions download -p input -c optiver-realized-volatility-prediction</code></pre>
<ul>
<li>Remove duplicate files and unzip the data</li>
</ul>
<pre><code>rm -rf input/*.parquet input/*.csv
unzip -d input -q input/optiver-realized-volatility-prediction.zip</code></pre>
<ul>
<li>If you’d like to save the metadata and results of the model training at neptune.ai, run the following with correct edits for your neptune project name and api token:</li>
</ul>
<pre><code>export NEPTUNE_PROJECT='neputune_username/project_name'
export NEPTUNE_API_TOKEN='YOUR_LONG_API_TOKEN'</code></pre>
<ul>
<li>Create the conda environment</li>
</ul>
<pre><code>conda env create -f env.yml
conda activate opt</code></pre>
<ul>
<li>Run <code>run.sh</code> to create features and train the model</li>
</ul>
<pre><code>bash run.sh</code></pre>
<p>This will create train features as a pickle file called p13_train.pkl and then train the lightgbm-dart model, with the output stored in the folder <code>dart_model</code></p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>