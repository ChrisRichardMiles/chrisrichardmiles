<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A submodule built for the 77th place solution for the M5-Accuracy competition on Kaggle.">

<title>../../chrisrichardmiles - Welcome to chrisrichardmiles.m5</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="../../chrisrichardmiles - Welcome to chrisrichardmiles.m5">
<meta property="og:description" content="A submodule built for the 77th place solution for the M5-Accuracy competition on Kaggle.">
<meta property="og:site-name" content="../../chrisrichardmiles">
<meta name="twitter:title" content="../../chrisrichardmiles - Welcome to chrisrichardmiles.m5">
<meta name="twitter:description" content="A submodule built for the 77th place solution for the M5-Accuracy competition on Kaggle.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">chrisrichardmiles</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Welcome to chrisrichardmiles.m5</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">chrisrichardmiles</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../core.html" class="sidebar-item-text sidebar-link">Core</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">projects</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">m5</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/index_m5.html" class="sidebar-item-text sidebar-link active">Welcome to chrisrichardmiles.m5</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/brief_eda.html" class="sidebar-item-text sidebar-link">Brief EDA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/feature_engineering.html" class="sidebar-item-text sidebar-link">Feature engineering</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/04_out_of_stock_detection.html" class="sidebar-item-text sidebar-link">Total sales for all series of aggregation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/m5/training_day_by_day_models.html" class="sidebar-item-text sidebar-link">Train day-by-day models</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">optiver</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/index_optiver.html" class="sidebar-item-text sidebar-link">Optiver Realized Volatility Prediction: 91st place solution</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/opt-error-analysis.html" class="sidebar-item-text sidebar-link">Error analysis</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">notebooks</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-book-trade-eda.html" class="sidebar-item-text sidebar-link">price features</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-eda-modified-from-host-nb.html" class="sidebar-item-text sidebar-link">Optiver Realized Volatility Prediction</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart-op-129a-stock-31-only.html" class="sidebar-item-text sidebar-link">opt-train-dart-op-129a-stock-31-only.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-dart.html" class="sidebar-item-text sidebar-link">opt-train-dart.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-one-at-a-time.html" class="sidebar-item-text sidebar-link">opt-train-one-at-a-time.html</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../projects/optiver/notebooks/opt-train-tabnet-142.html" class="sidebar-item-text sidebar-link">opt-train-tabnet-142.html</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#create-submission-from-scratch-from-the-command-line" id="toc-create-submission-from-scratch-from-the-command-line" class="nav-link active" data-scroll-target="#create-submission-from-scratch-from-the-command-line">Create submission from scratch from the command line</a>
  <ul class="collapse">
  <li><a href="#install-package" id="toc-install-package" class="nav-link" data-scroll-target="#install-package">1. Install package</a></li>
  <li><a href="#create-data-folders-download-data-and-unzip-files" id="toc-create-data-folders-download-data-and-unzip-files" class="nav-link" data-scroll-target="#create-data-folders-download-data-and-unzip-files">2. Create data folders, download data, and unzip files</a></li>
  <li><a href="#detect-out-of-stock-days-for-products-and-change-sales-to-nan." id="toc-detect-out-of-stock-days-for-products-and-change-sales-to-nan." class="nav-link" data-scroll-target="#detect-out-of-stock-days-for-products-and-change-sales-to-nan.">3. Detect out of stock days for products and change sales to NaN.</a></li>
  <li><a href="#create-features-for-training" id="toc-create-features-for-training" class="nav-link" data-scroll-target="#create-features-for-training">4. Create features for training</a></li>
  <li><a href="#train-models-and-create-submission" id="toc-train-models-and-create-submission" class="nav-link" data-scroll-target="#train-models-and-create-submission">5. Train models and create submission</a></li>
  </ul></li>
  <li><a href="#overview-of-solution" id="toc-overview-of-solution" class="nav-link" data-scroll-target="#overview-of-solution">Overview of solution</a></li>
  <li><a href="#some-lessons-i-learned" id="toc-some-lessons-i-learned" class="nav-link" data-scroll-target="#some-lessons-i-learned">Some lessons I learned</a>
  <ul class="collapse">
  <li><a href="#ram-issues" id="toc-ram-issues" class="nav-link" data-scroll-target="#ram-issues">RAM issues</a></li>
  <li><a href="#organization-is-important" id="toc-organization-is-important" class="nav-link" data-scroll-target="#organization-is-important">Organization is important</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/chrisrichardmiles/chrisrichardmiles/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Welcome to chrisrichardmiles.m5</h1>
</div>

<div>
  <div class="description">
    A submodule built for the 77th place solution for the M5-Accuracy competition on Kaggle.
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This package is built with <a href="https://nbdev.fast.ai/">nbdev</a>, so the source code, testing, and documentation are all built in jupyter notebooks. For full solution details, read through documentation, or the 5 notebooks which are used to create the documentation.</p>
<section id="create-submission-from-scratch-from-the-command-line" class="level2">
<h2 class="anchored" data-anchor-id="create-submission-from-scratch-from-the-command-line">Create submission from scratch from the command line</h2>
<p>Requirements: 20 GB of RAM and pip installed</p>
<section id="install-package" class="level3">
<h3 class="anchored" data-anchor-id="install-package">1. Install package</h3>
<p><code>pip install chrisrichardmiles</code></p>
</section>
<section id="create-data-folders-download-data-and-unzip-files" class="level3">
<h3 class="anchored" data-anchor-id="create-data-folders-download-data-and-unzip-files">2. Create data folders, download data, and unzip files</h3>
<section id="if-you-have-your-kaggle-api-info-in-root.kagglekaggle.json-then-run" class="level4">
<h4 class="anchored" data-anchor-id="if-you-have-your-kaggle-api-info-in-root.kagglekaggle.json-then-run">If you have your kaggle api info in root/.kaggle/kaggle.json then run:</h4>
<pre><code>crm_download_kaggle_data --comp_name m5-forecasting-accuracy</code></pre>
</section>
<section id="otherwise-you-must-run" class="level4">
<h4 class="anchored" data-anchor-id="otherwise-you-must-run">Otherwise, you must run:</h4>
<pre><code>crm_mkdirs_data</code></pre>
<p>and manully download the data zipfile from <a href="https://www.kaggle.com/c/m5-forecasting-accuracy/data">kaggle</a> and upload it into the data/raw folder.</p>
<pre><code>cd data/raw
unzip * 
cd ../..</code></pre>
</section>
</section>
<section id="detect-out-of-stock-days-for-products-and-change-sales-to-nan." class="level3">
<h3 class="anchored" data-anchor-id="detect-out-of-stock-days-for-products-and-change-sales-to-nan.">3. Detect out of stock days for products and change sales to NaN.</h3>
<pre><code>crm_m5_make_oos_data</code></pre>
</section>
<section id="create-features-for-training" class="level3">
<h3 class="anchored" data-anchor-id="create-features-for-training">4. Create features for training</h3>
<pre><code>crm_m5_fe</code></pre>
</section>
<section id="train-models-and-create-submission" class="level3">
<h3 class="anchored" data-anchor-id="train-models-and-create-submission">5. Train models and create submission</h3>
<pre><code>crm_m5_lgb_daily</code></pre>
</section>
</section>
<section id="overview-of-solution" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-solution">Overview of solution</h2>
<ul>
<li>Given Walmart sales data, tasked with delivering accurate hierarchical sales forecasts over 28 days, preventing potential losses in the millions resulting from overstocking and understocking, my solution placed 77th of 5,558 teams (top 1.4%) with a simple, explainable tree-based model, using LightGBM. It is also a pip installable software package, with testing, documentation, and continuous integration, found at my github.</li>
<li>Given a novel scoring metric, I used calculus and numpy to implement a custom objective function utilizable by LightGBM models. After discovering non-convexity, I created another custom function, utilizing insights about the data and metric, which outperformed all other publicly known methods.</li>
<li>With stockout-days non-differentiable from zero-sales-days, I used probability to detect stockout days by assuming sales were Poisson distributed, finding streaks of zeroes that were unreasonably long, given the average daily sales of a product, leading to enhanced data, more effective features, and superior models.</li>
<li>With limited memory resources, I utilized principal component analysis from scikit-learn to reduce dimensionality of features, allowing more total features and better model performance.</li>
<li>Needing feature engineering that did not exist in pandas, I used numpy to calculate novel rolling window features, also giving a 20x speed up, useful to speed up data pipelines.</li>
</ul>
</section>
<section id="some-lessons-i-learned" class="level2">
<h2 class="anchored" data-anchor-id="some-lessons-i-learned">Some lessons I learned</h2>
<section id="ram-issues" class="level3">
<h3 class="anchored" data-anchor-id="ram-issues">RAM issues</h3>
<ul>
<li>Computing rolling window statistics can be very expensive, but can be ok if we do processing in smaller sections like we do with <code>n_splits</code> in the <a href="https://chrisrichardmiles.github.io/chrisrichardmiles/projects/m5/feature_engineering.html#rolling_window"><code>rolling_window</code></a> statistics calculations.</li>
<li>Datatype matter: float32 and float16 datatypes can save a lot of RAM, but be careful for float16, which might cause accuracy problems or completely break a process, like when trying to use <code>StandardScaler</code> with float16 datatypes resulted in all zeros.</li>
<li>Be careful with Pandas DataFrames. I had a lot of problems where I was unmindfully creating large copies of data, such as a saving function, looking something like <code>df[cols].to_csv(....)</code> which was making an entirely new dataframe in memory before saving. This was remedied by using the <code>usecols</code> param in <code>df.to_csv</code></li>
<li>Be careful with DataFrame names. It seems that it is better to keep the same name of a DataFrame when doing things like concating an existing df with new data. Its like pandas will use memory more intelligently. So this: <code>df2 = pd.concat([df1, pd.read_csv('data.csv')]; del df2</code> should be replaced with <code>df1 = pd.concat([df1, pd.read_csv('data.csv')]</code>. It seems like it should work the same, but my experience with RAM crashes seems to indicate the second method is much better.</li>
</ul>
</section>
<section id="organization-is-important" class="level3">
<h3 class="anchored" data-anchor-id="organization-is-important">Organization is important</h3>
<p>The first iteration of this project was code spread accross hundreds of kaggle notebooks. I ran experiments by running a notebook and just looking at the result. It always felt ok while I was doing it, and it worked out ok, but I didn’t have the results saved in a proper manner. Now I use neptune.ai to track experiments.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>